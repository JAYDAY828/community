<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™ë˜ì—° ë¸”ë¡œê·¸ ë¹„ì„œ (Pro)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- HEIC Converter -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .prose h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #1f2937;
        }

        .prose h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #374151;
        }

        .prose p {
            margin-bottom: 1rem;
            line-height: 1.7;
            color: #4b5563;
        }

        .prose strong {
            color: #111827;
            font-weight: 600;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #db2777;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #d1d5db;
        }

        .tab-active {
            border-bottom: 2px solid #db2777;
            color: #db2777;
            font-weight: 700;
        }

        .tab-inactive {
            color: #6b7280;
            font-weight: 500;
        }

        .tab-inactive:hover {
            color: #374151;
        }

        #publishPanelContent {
            transition: max-height 0.24s ease, opacity 0.2s ease;
        }

        @media (max-width: 1023.98px) {
            #publishPanelContent {
                max-height: 0;
                opacity: 0;
                overflow-y: hidden;
            }

            #publishPanelContent.is-open {
                max-height: min(60vh, 560px);
                opacity: 1;
                overflow-y: auto;
            }
        }

        @media (min-width: 1024px) {
            #publishPanelContent {
                max-height: none !important;
                opacity: 1 !important;
                overflow-y: auto !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-20">
        <div class="px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸ€</span>
                <h1 class="text-xl font-bold text-gray-800">í™ë˜ì—° ë¸”ë¡œê·¸ ë¹„ì„œ</h1>
                <span class="bg-pink-100 text-pink-700 text-xs px-2 py-1 rounded-full font-bold">PRO</span>
            </div>
            <button onclick="toggleSettings()"
                class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition flex items-center gap-1">
                <span>âš™ï¸ ì„¤ì •</span>
            </button>
        </div>

        <!-- Tabs -->
        <div class="flex px-6 gap-8">
            <button onclick="switchTab('writer')" id="tab-writer" class="pb-3 px-1 transition-all tab-active">
                âœï¸ ê¸€ì“°ê¸°
            </button>
            <button onclick="switchTab('manager')" id="tab-manager" class="pb-3 px-1 transition-all tab-inactive">
                ğŸ“Š ê´€ë¦¬ ë„êµ¬
            </button>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div
            class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl mx-4 transform transition-all scale-100 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold flex items-center gap-2">âš™ï¸ ì„¤ì •</h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-5">
                <section class="rounded-xl border border-gray-200 p-4">
                    <h3 class="text-base font-bold text-gray-800 mb-2 flex items-center gap-2">ğŸ”‘ API í‚¤ ê´€ë¦¬</h3>
                    <p class="text-sm text-gray-500 mb-3 leading-relaxed">
                        Gemini API í‚¤ë¥¼ ì—¬ëŸ¬ ê°œ ì €ì¥í•´ë‘ê³  ìƒí™©ì— ë§ê²Œ ë°”ê¿” ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        <a href="https://aistudio.google.com/app/apikey" target="_blank"
                            class="text-pink-500 font-medium hover:underline ml-1">ë¬´ë£Œ í‚¤ ë°œê¸‰</a>
                    </p>

                    <div class="space-y-2">
                        <input type="text" id="apiKeyAliasInput" placeholder="í‚¤ ì´ë¦„(ì„ íƒ) ì˜ˆ: ê°œì¸ê³„ì • A"
                            class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition shadow-sm">
                        <input type="password" id="apiKeyInput" placeholder="AIzaSy..."
                            class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none transition shadow-sm">
                        <button id="saveBtn" onclick="saveApiKey()"
                            class="w-full px-4 py-2.5 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition font-medium shadow-sm">
                            í‚¤ ì €ì¥
                        </button>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <label for="apiKeySelect" class="block text-xs font-semibold text-gray-600 mb-2">ì €ì¥ëœ í‚¤</label>
                        <select id="apiKeySelect"
                            class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 outline-none"></select>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
                            <button id="useSelectedBtn" onclick="activateSelectedApiKey()"
                                class="px-4 py-2.5 bg-gray-800 text-white rounded-lg hover:bg-black transition text-sm font-semibold">ì„ íƒ í‚¤ ì‚¬ìš©</button>
                            <button id="disconnectBtn" onclick="disconnectApiKey()"
                                class="px-4 py-2.5 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm font-semibold">ì„ íƒ í‚¤ ì‚­ì œ</button>
                        </div>
                        <p id="apiKeyStatusText" class="text-xs text-gray-500 mt-2">í™œì„± API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </section>

                <section class="rounded-xl border border-gray-200 p-4">
                    <h3 class="text-base font-bold text-gray-800 mb-2 flex items-center gap-2">ğŸ—£ï¸ ë§íˆ¬ í”„ë¡œí•„ ì„¤ì •</h3>
                    <p class="text-sm text-gray-500 mb-3 leading-relaxed">
                        ê¸€ì“°ê¸° ë¹„ì„œì™€ ê´€ë¦¬ ë„êµ¬ ì „ì—­ì— ì ìš©í•  ë§íˆ¬ í”„ë¡œí•„ì„ ì—¬ê¸°ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
                    </p>
                    <div class="space-y-2">
                        <input type="text" id="blogIdInput" placeholder="ë„¤ì´ë²„ ì•„ì´ë”” ë˜ëŠ” ë¸”ë¡œê·¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-pink-500 outline-none text-sm">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <button onclick="saveBlogId()"
                                class="bg-gray-800 text-white px-4 py-2.5 rounded-lg font-semibold hover:bg-black transition text-sm">ID ì €ì¥</button>
                            <button onclick="refreshToneProfile()"
                                class="bg-pink-600 text-white px-4 py-2.5 rounded-lg font-semibold hover:bg-pink-700 transition text-sm whitespace-nowrap">í”„ë¡œí•„ ê°±ì‹ </button>
                            <button onclick="resetToneProfile()"
                                class="bg-white border border-gray-300 text-gray-700 px-4 py-2.5 rounded-lg font-semibold hover:bg-gray-50 transition text-sm">ì´ˆê¸° ë¦¬ì…‹</button>
                        </div>
                        <p id="toneStatusText" data-tone-status class="text-xs text-gray-500 mt-2">ë§íˆ¬ í”„ë¡œí•„: ì•„ì§ ë¶„ì„í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="flex-1 flex overflow-hidden relative">

        <!-- Tab 1: Writer -->
        <div id="view-writer"
            class="w-full h-full flex flex-col lg:flex-row absolute inset-0 transition-opacity duration-300">
            <!-- Left Panel: Controls (Fixed width on Desktop) -->
            <div
                class="w-full lg:w-[400px] lg:flex-shrink-0 bg-white border-r border-gray-200 flex flex-col h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
                <div id="writerControlsScroll" class="p-6 flex-1 overflow-y-auto custom-scrollbar">
                    <div class="mb-8">
                        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">1. ì£¼ì œ ë° í‚¤ì›Œë“œ
                            <span
                                class="text-xs font-normal text-pink-500 bg-pink-50 px-2 py-0.5 rounded-full">í•„ìˆ˜</span></label>
                        <textarea id="topicInput" rows="5"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 focus:ring-2 focus:ring-pink-500 focus:bg-white transition resize-none text-sm placeholder-gray-400 leading-relaxed shadow-sm"
                            placeholder="ì˜ˆ: íŒŒì£¼ 'ì¹´í˜ ë©œë¡œìš°' ë°©ë¬¸ í›„ê¸°.&#10;- ì£¼ì°¨ì¥ ë„“ìŒ, 2ì‹œê°„ ë¬´ë£Œ&#10;- ì†Œê¸ˆë¹µ(3,500ì›) ê°•ì¶”&#10;- ë‚¨í¸ì´ë‘ ë°ì´íŠ¸"></textarea>
                    </div>
                    <div class="mb-8">
                        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">1-1. ì‘ì„± ë³´ì¡° ì •ë³´
                            <span
                                class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">ì„ íƒ</span></label>
                        <div class="grid grid-cols-1 gap-3">
                            <input type="text" id="mainKeywordInput" placeholder="ìš°ì„  í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„) ì˜ˆ: íŒŒì£¼ì¹´í˜, ë‚´ëˆë‚´ì‚°, ë°ì´íŠ¸ì½”ìŠ¤"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-pink-500 focus:bg-white transition text-sm placeholder-gray-400 shadow-sm">
                            <input type="text" id="targetReaderInput" placeholder="íƒ€ê¹ƒ ë…ì ì˜ˆ: ì£¼ë§ ë°ì´íŠ¸ ì°¾ëŠ” 30ëŒ€ ë¶€ë¶€"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-pink-500 focus:bg-white transition text-sm placeholder-gray-400 shadow-sm">
                            <p class="text-[11px] text-gray-500 leading-relaxed">
                                íŒ: ì…ë ¥í•œ ì •ë³´ëŠ” AIê°€ "ì™„ì„±ë³¸ ëŒ€í•„"ì´ ì•„ë‹ˆë¼ ì‘ì„± ë³´ì¡°ìš© êµ¬ì¡°/ì œëª©/ë…¸ì¶œ ì œì•ˆì—ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                    <div class="mb-8">
                        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">2. ì‚¬ì§„ ì—…ë¡œë“œ
                            <span
                                class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">ì„ íƒ</span></label>
                        <div id="dropZone"
                            class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-pink-400 hover:bg-pink-50 transition cursor-pointer group"
                            onclick="document.getElementById('imageInput').click()">
                            <input type="file" id="imageInput" multiple accept="image/*" class="hidden"
                                onchange="handleImageSelect(event)" onclick="this.value=''" autocomplete="off">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition duration-300 transform">ğŸ“¸</div>
                            <p class="text-sm text-gray-600 font-medium">ì‚¬ì§„ ë“œë˜ê·¸ ë˜ëŠ” í´ë¦­</p>
                        </div>

                        <!-- Photo Guide Fixed Structure -->
                        <div
                            class="mt-3 bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs text-gray-600 leading-relaxed">
                            <div class="flex justify-between items-center mb-2">
                                <p id="photoGuideStatus" class="font-semibold text-gray-700">ì„ íƒ 0ì¥ Â· ê¶Œì¥ 8~20ì¥ Â· ìµœëŒ€ 30ì¥
                                </p>
                                <button onclick="clearAllImages()"
                                    class="text-gray-400 hover:text-red-500 underline text-[11px] whitespace-nowrap ml-2 px-2 py-1 flex-shrink-0">
                                    ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
                                </button>
                            </div>
                            <div class="block border-t border-gray-200 pt-2 border-dashed">
                                <p class="mb-1 font-medium text-gray-500">ì¶”ì²œ êµ¬ì„±:</p>
                                <ul class="list-disc pl-4 space-y-0.5">
                                    <li>ëŒ€í‘œì»· 1~2ì¥, ì¥ì†Œ/ì™¸ê´€ 1~2ì¥</li>
                                    <li>ë¶„ìœ„ê¸°/ë‚´ë¶€ 2~4ì¥, í•µì‹¬ ê²½í—˜ì»· 3~6ì¥</li>
                                    <li>ì •ë³´ ì¦ë¹™ì»·(ê°€ê²©í‘œ/ì˜ìˆ˜ì¦/ì•ˆë‚´ë¬¸) 1~2ì¥</li>
                                </ul>
                            </div>
                        </div>

                        <div id="imagePreview" class="grid grid-cols-3 gap-2 mt-4"></div>
                    </div>
                    <div class="mb-2 rounded-xl border border-gray-200 bg-white/70 p-3">
                        <p class="text-[11px] font-semibold text-gray-600 mb-2">ê¶Œì¥ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ì„¸ìš”</p>
                        <div class="space-y-2">
                            <button onclick="generatePost()"
                                class="w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-pink-200 transform active:scale-[0.98] transition-all flex justify-center items-center gap-2 group">
                                <span class="group-hover:animate-bounce">ğŸ§­</span><span>1. ì´ˆì•ˆ ë§Œë“¤ê¸°</span>
                            </button>
                            <button onclick="fixSpelling()"
                                class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-50 flex justify-center items-center gap-2">
                                âœï¸ 2. ë¬¸ì¥ ë‹¤ë“¬ê¸°
                            </button>
                            <button onclick="runLocalSeoCheck()"
                                class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-50 flex justify-center items-center gap-2">
                                ğŸ“Œ 3. ë…¸ì¶œ ê°€ëŠ¥ì„± ì ê²€
                            </button>
                            <button onclick="onExternalRiskButtonClick()"
                                class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-50 flex justify-center items-center gap-2">
                                <span id="externalRiskButtonLabel">ğŸŒ¤ï¸ 4. ì™¸ë¶€ í™˜ê²½ ë¦¬ìŠ¤í¬ ì ê²€</span>
                            </button>
                            <button onclick="generatePublishPack()"
                                class="w-full bg-rose-50 border border-rose-200 text-rose-700 font-bold py-3 rounded-xl hover:bg-rose-100 flex justify-center items-center gap-2">
                                ğŸ·ï¸ 5. ë°œí–‰ ìš”ì†Œ ìƒì„±
                            </button>
                        </div>
                        <div id="externalRiskPanel"
                            class="mt-3 hidden grid grid-cols-1 sm:grid-cols-2 gap-2 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                            <div class="sm:col-span-2 flex items-start justify-between gap-2 mb-1">
                                <p class="text-[11px] text-gray-600 leading-relaxed break-keep pr-1">4ë²ˆ ì ê²€ ì „ìš© ì…ë ¥ì…ë‹ˆë‹¤. ëª¨ë¥´ë©´ ê¸°ë³¸ê°’(ë³´í†µ) ìœ ì§€ í›„ ì‹¤í–‰í•˜ì„¸ìš”.</p>
                                <button type="button" onclick="hideExternalRiskPanel()"
                                    class="shrink-0 whitespace-nowrap px-1 py-0.5 text-[11px] text-gray-500 underline hover:text-gray-700">ë‹«ê¸°</button>
                            </div>
                            <label class="text-[11px] text-gray-600">
                                ê²½ìŸë„
                                <select id="riskCompetitionInput"
                                    class="mt-1 w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-white">
                                    <option value="25">ë‚®ìŒ</option>
                                    <option value="55" selected>ë³´í†µ</option>
                                    <option value="85">ë†’ìŒ</option>
                                </select>
                            </label>
                            <label class="text-[11px] text-gray-600">
                                ì‹œì¦Œì„±
                                <select id="riskSeasonalityInput"
                                    class="mt-1 w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-white">
                                    <option value="25">ì„±ìˆ˜ê¸°/ì í•©</option>
                                    <option value="55" selected>ë³´í†µ</option>
                                    <option value="85">ë¹„ìˆ˜ê¸°/ë¶€ì í•©</option>
                                </select>
                            </label>
                            <label class="text-[11px] text-gray-600">
                                ì£¼ì œ í¬í™”ë„
                                <select id="riskSaturationInput"
                                    class="mt-1 w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-white">
                                    <option value="25">ë‚®ìŒ</option>
                                    <option value="55" selected>ë³´í†µ</option>
                                    <option value="85">ë†’ìŒ</option>
                                </select>
                            </label>
                            <label class="text-[11px] text-gray-600">
                                ë°œí–‰ íƒ€ì´ë°
                                <select id="riskTimingInput"
                                    class="mt-1 w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-white">
                                    <option value="25">ì¢‹ìŒ</option>
                                    <option value="55" selected>ë³´í†µ</option>
                                    <option value="80">ì•„ì‰¬ì›€</option>
                                </select>
                            </label>
                            <label class="text-[11px] text-gray-600 sm:col-span-2">
                                ìµœê·¼ í™œë™ì„±
                                <select id="riskActivityInput"
                                    class="mt-1 w-full border border-gray-300 rounded-md px-2 py-1.5 text-xs bg-white">
                                    <option value="20">í™œë°œí•¨</option>
                                    <option value="50" selected>ë³´í†µ</option>
                                    <option value="80">ë‚®ìŒ</option>
                                </select>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Central Area: Content Editor + Publishing Panel (Flex container) -->
            <div class="flex-1 flex flex-col lg:flex-row h-full overflow-hidden relative">

                <!-- Editor Section -->
                <div class="flex-1 flex flex-col h-full bg-gray-50 relative min-w-0">
                    <div id="loadingOverlay"
                        class="absolute inset-0 bg-white/90 backdrop-blur-sm z-30 flex flex-col items-center justify-center hidden">
                        <div class="loading-spinner mb-6"></div>
                        <h3 class="text-xl font-bold text-gray-800 animate-pulse">AIê°€ ì—´ì‹¬íˆ ì¼í•˜ê³  ìˆì–´ìš”!</h3>
                        <p class="text-sm text-gray-500 mt-2" id="loadingText">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                    </div>

                    <!-- Editor Scroll Area -->
                    <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
                        <div id="outputContent"
                            class="prose max-w-3xl mx-auto bg-white p-8 md:p-12 rounded-2xl shadow-sm min-h-[800px] outline-none border border-gray-100 text-gray-800"
                            contenteditable="true">
                            <div
                                class="flex flex-col items-center justify-center h-full text-gray-300 select-none py-20">
                                <div class="text-6xl mb-6 opacity-50">âœï¸</div>
                                <h3 class="text-xl font-bold text-gray-400 mb-2">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                                <p class="text-sm text-gray-400">ì£¼ì œì™€ ì‚¬ì§„ì„ ë„£ê³ <br>ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Bar -->
                    <div
                        class="bg-white border-t border-gray-200 px-6 py-4 flex justify-between items-center shadow-[0_-4px_24px_rgba(0,0,0,0.02)] z-20">
                        <div class="flex flex-col gap-1">
                            <span class="text-xs font-medium text-gray-400 flex items-center gap-1"><span
                                    class="w-2 h-2 rounded-full bg-green-400"></span>Gemini Ready</span>
                            <span class="text-xs text-gray-500">
                                ê³µë°± í¬í•¨ <span id="charCountWithSpace">0</span>ì / ì œì™¸ <span
                                    id="charCountWithoutSpace">0</span>ì
                            </span>
                            <div class="flex gap-2">
                                <span id="seoScoreBadge" class="text-[11px] text-gray-400">3ë‹¨ê³„ ì ê²€ ì „</span>
                                <span id="externalRiskBadge" class="text-[11px] text-gray-400">4ë‹¨ê³„ ì ê²€ ì „</span>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="downloadAsFile()"
                                class="text-sm bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition font-medium">ğŸ’¾
                                ì €ì¥</button>
                            <button onclick="copyToClipboard()"
                                class="text-sm bg-gray-900 text-white px-5 py-2 rounded-lg hover:bg-black transition font-medium shadow-md">ğŸ“‹
                                ì „ì²´ ë³µì‚¬</button>
                        </div>
                    </div>
                </div>

                <!-- Publishing Panel: Right Sidebar (Desktop) / Bottom Collapsible (Mobile) -->
                <div id="publishPanel"
                    class="border-t lg:border-t-0 lg:border-l border-gray-200 bg-white lg:w-[420px] xl:w-[520px] flex-shrink-0 flex flex-col transition-all duration-300 z-20 shadow-[-4px_0_24px_rgba(0,0,0,0.02)]">

                    <!-- Panel Header -->
                    <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between bg-gray-50 lg:bg-white">
                        <div class="flex items-center gap-2">
                            <h4 class="font-bold text-gray-800 text-sm">ë°œí–‰ ìš”ì†Œ (ì œëª©/íƒœê·¸)</h4>
                            <span id="assistStatus" class="text-[11px] text-gray-500">ëŒ€ê¸° ì¤‘</span>
                        </div>
                        <!-- Toggle Button (Mobile Only) -->
                        <button id="publishPanelToggleBtn" onclick="togglePublishPanelMobile()" aria-expanded="false"
                            class="lg:hidden text-gray-400 hover:text-gray-600 transition">
                            ğŸ”¼
                        </button>
                    </div>

                    <!-- Panel Content -->
                    <div id="publishPanelContent"
                        class="flex-1 custom-scrollbar p-0">
                        <div id="assistContent" class="prose prose-sm max-w-none px-5 py-4 text-sm text-gray-600">
                            <p>1~3ë‹¨ê³„ ì ê²€ í›„ 4ë²ˆ ë²„íŠ¼ìœ¼ë¡œ ì™¸ë¶€ ë¦¬ìŠ¤í¬ë¥¼ ì ê²€í•˜ê³ , ë§ˆì§€ë§‰ì— <strong>5. ë°œí–‰ ìš”ì†Œ ìƒì„±</strong>ì„ ì‹¤í–‰í•˜ì„¸ìš”.</p>
                            <div class="mt-4 p-3 bg-blue-50 text-blue-800 rounded-lg text-xs leading-relaxed">
                                ğŸ’¡ <strong>íŒ:</strong><br>
                                PC ë“± ë„“ì€ í™”ë©´ì—ì„œëŠ” ì´ íŒ¨ë„ì´ ìš°ì¸¡ì— ê³ ì •ë˜ì–´, ê¸€ì„ ì“°ë©´ì„œ ë™ì‹œì— ë°œí–‰ ì •ë³´ë¥¼ ì°¸ê³ í•˜ê¸° í¸í•©ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Tab 2: Manager -->
        <div id="view-manager"
            class="w-full h-full flex flex-col absolute inset-0 bg-gray-50 hidden opacity-0 transition-opacity duration-300 overflow-y-auto custom-scrollbar">
            <div class="max-w-5xl mx-auto w-full p-8">

                <!-- Section 1: My Blog Dashboard -->
                <div class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-8 mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        ğŸ“¡ ë‚´ ë¸”ë¡œê·¸ ê´€ì œíƒ‘
                    </h2>
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="legacyBlogIdInput" placeholder="ë„¤ì´ë²„ ì•„ì´ë”” ë˜ëŠ” ë¸”ë¡œê·¸ ì£¼ì†Œ (https://blog.naver.com/...)"
                            class="flex-1 border border-gray-300 rounded-xl p-4 focus:ring-2 focus:ring-pink-500 outline-none text-lg">
                        <button onclick="saveBlogId()"
                            class="bg-gray-800 text-white px-8 rounded-xl font-bold hover:bg-black transition">ì €ì¥</button>
                        <button onclick="refreshToneProfile()"
                            class="bg-pink-600 text-white px-6 rounded-xl font-bold hover:bg-pink-700 transition whitespace-nowrap">ë§íˆ¬
                            ë¶„ì„</button>
                    </div>
                    <p id="legacyToneStatusText" class="text-xs text-gray-500 mb-6">ë§íˆ¬ í”„ë¡œí•„: ì•„ì§ ë¶„ì„í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div onclick="openAnalysis('blackkiwi')"
                            class="cursor-pointer bg-blue-50 border border-blue-100 p-6 rounded-xl hover:shadow-md transition group">
                            <div class="text-2xl mb-2">ğŸ¥</div>
                            <h3 class="font-bold text-blue-900 mb-1">ë¸”ë™í‚¤ìœ„ ë¶„ì„</h3>
                            <p class="text-sm text-blue-600">í‚¤ì›Œë“œ í¬í™”ë„ & ë“±ê¸‰ í™•ì¸</p>
                        </div>
                        <div onclick="openAnalysis('blogchart')"
                            class="cursor-pointer bg-green-50 border border-green-100 p-6 rounded-xl hover:shadow-md transition group">
                            <div class="text-2xl mb-2">ğŸ“Š</div>
                            <h3 class="font-bold text-green-900 mb-1">ë¸”ë¡œê·¸ ì°¨íŠ¸</h3>
                            <p class="text-sm text-green-600">ë‚´ ë¸”ë¡œê·¸ ì „ì²´ ìˆœìœ„ í™•ì¸</p>
                        </div>
                        <div onclick="openAnalysis('naverstats')"
                            class="cursor-pointer bg-gray-50 border border-gray-200 p-6 rounded-xl hover:shadow-md transition group">
                            <div class="text-2xl mb-2">ğŸ“ˆ</div>
                            <h3 class="font-bold text-gray-900 mb-1">ë„¤ì´ë²„ í†µê³„</h3>
                            <p class="text-sm text-gray-600">ê³µì‹ ë°©ë¬¸ì í†µê³„ ë°”ë¡œê°€ê¸°</p>
                        </div>
                    </div>
                </div>

                <!-- Section 1: Quick Polish -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                        âœï¸ ë¹ ë¥¸ ë§ì¶¤ë²•/ë¬¸ì¥ êµì •
                    </h2>
                    <p class="text-sm text-gray-500 mb-6">ì™„ì„± ëŒ€í•„ì´ ì•„ë‹ˆë¼, ì‘ì„±ìê°€ ìµœì¢… ìˆ˜ì •í•˜ê¸° ì‰½ê²Œ ë¬¸ì¥ í’ˆì§ˆë§Œ ë¹ ë¥´ê²Œ ì •ë¦¬í•©ë‹ˆë‹¤.</p>

                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 xl:items-stretch">
                        <div class="bg-gray-50 rounded-xl border border-gray-200 p-5 flex flex-col min-h-[420px]">
                            <label class="block text-sm font-bold text-gray-700 mb-2">êµì •í•  ë¬¸ì¥/ë¬¸ë‹¨</label>
                            <textarea id="managerQuickInput"
                                class="w-full flex-1 min-h-[260px] bg-white border border-gray-200 rounded-xl p-4 resize-none focus:ring-2 focus:ring-pink-500 outline-none text-sm text-gray-700"
                                placeholder="êµì •í•  ë¬¸ì¥ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#10;ì™„ì „ ì¬ì‘ì„±ë³´ë‹¤, ë§ì¶¤ë²•/ë¬¸ì¥ íë¦„ ì •ë¦¬ì— ì§‘ì¤‘í•©ë‹ˆë‹¤."></textarea>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <button onclick="fillManagerQuickInputFromWriter()"
                                    class="text-xs bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-50 transition">ê¸€ì“°ê¸° ë³¸ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                <button onclick="clearManagerQuickInput()"
                                    class="text-xs bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-50 transition">ì…ë ¥ ë¹„ìš°ê¸°</button>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-xl border border-gray-200 p-5 flex flex-col min-h-[420px]">
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button onclick="runManagerSpellingCheck()"
                                    class="bg-gray-900 text-white text-xs px-3 py-2 rounded-lg hover:bg-black transition font-semibold">ë§ì¶¤ë²• ê²€ì‚¬</button>
                                <button onclick="runManagerSentencePolish()"
                                    class="bg-pink-600 text-white text-xs px-3 py-2 rounded-lg hover:bg-pink-700 transition font-semibold">ë¬¸ì¥ ë‹¤ë“¬ê¸°</button>
                                <button onclick="copyManagerQuickResult()"
                                    class="bg-white border border-gray-300 text-gray-700 text-xs px-3 py-2 rounded-lg hover:bg-gray-100 transition">ê²°ê³¼ ë³µì‚¬</button>
                            </div>
                            <div id="managerQuickResult"
                                class="prose prose-sm max-w-none text-sm text-gray-700 flex-1 min-h-0 overflow-y-auto custom-scrollbar">
                                <p class="text-gray-400 text-center mt-10">ë§ì¶¤ë²• ê²€ì‚¬ë‚˜ ë¬¸ì¥ ë‹¤ë“¬ê¸° ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 border-t border-dashed border-gray-200 pt-5">
                        <p data-tone-status class="text-xs text-gray-500">ë§íˆ¬ í”„ë¡œí•„: ì•„ì§ ë¶„ì„í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- Section 2: Post Audit -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                        ğŸ©º í¬ìŠ¤íŒ… ì •ë°€ ì§„ë‹¨
                    </h2>
                    <p class="text-sm text-gray-500 mb-6">ì™„ì„± ëŒ€í•„ì´ ì•„ë‹ˆë¼, ê°•ì /ë¦¬ìŠ¤í¬/ìš°ì„  ìˆ˜ì • ì•¡ì…˜ ì¤‘ì‹¬ìœ¼ë¡œ ì ê²€í•´ ìµœì¢… ì‘ì„± íŒë‹¨ì„ ë•ìŠµë‹ˆë‹¤.</p>

                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 min-h-[520px]">
                        <div class="flex flex-col gap-3">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">í¬ìŠ¤íŒ… ì£¼ì†Œ (URL)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="auditUrlInput"
                                        placeholder="ì˜ˆ: https://blog.naver.com/hongttoyeon/223..."
                                        class="flex-1 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-pink-500 outline-none text-sm">
                                    <button onclick="fetchAndAuditPost()"
                                        class="bg-gray-800 text-white px-4 rounded-lg font-bold hover:bg-black transition whitespace-nowrap">ê°€ì ¸ì˜¤ê¸°</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ë³µì‚¬ ë°©ì§€ëœ ê¸€ë„ ì£¼ì†Œë§Œ ë„£ìœ¼ë©´ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
                            </div>

                            <div class="flex-1 flex flex-col">
                                <div class="flex items-center justify-between gap-2 mb-1">
                                    <label class="block text-sm font-bold text-gray-700 mb-0">ì§„ë‹¨í•  ë³¸ë¬¸</label>
                                    <button type="button" onclick="fillAuditInputFromWriterDraft()"
                                        class="text-[11px] bg-white border border-gray-300 text-gray-600 px-2.5 py-1 rounded-md hover:bg-gray-50 transition whitespace-nowrap">ê¸€ì“°ê¸° ë³¸ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                </div>
                                <textarea id="auditInput"
                                    class="w-full flex-1 min-h-[240px] bg-gray-50 border border-gray-200 rounded-xl p-4 resize-none focus:ring-2 focus:ring-pink-500 outline-none text-sm text-gray-600"
                                    placeholder="URLì„ ì…ë ¥í•˜ê³  'ê°€ì ¸ì˜¤ê¸°'ë¥¼ ëˆ„ë¥´ì„¸ìš”.&#10;ë˜ëŠ” ì—¬ê¸°ì— ì§ì ‘ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì…”ë„ ë©ë‹ˆë‹¤."></textarea>
                            </div>

                            <button onclick="auditPost()"
                                class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-xl shadow-md transition">
                                ğŸš€ AI ì •ë°€ì§„ë‹¨ ì‹¤í–‰
                            </button>
                        </div>
                        <div class="bg-gray-50 rounded-xl border border-gray-200 p-6 overflow-y-auto min-h-[320px]">
                            <div id="auditResult" class="prose text-sm">
                                <p class="text-gray-400 text-center mt-20">ì§„ë‹¨ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script>
        // --- Configuration ---
        const DEFAULT_GEMINI_MODEL = "gemini-2.0-flash";
        const GEMINI_MODEL_PREFERENCES = [
            "gemini-2.5-flash",
            "gemini-2.0-flash",
            "gemini-1.5-flash",
            "gemini-1.5-pro",
            "gemini-1.0-pro"
        ];
        const TONE_SAMPLE_COUNT = 12;
        const TONE_CACHE_TTL_MS = 1000 * 60 * 60 * 24 * 3; // 3 days
        const TONE_CACHE_PREFIX = "naver_tone_profile_";
        const API_KEY_LIST_STORAGE_KEY = "gemini_api_keys_v1";
        const API_KEY_ACTIVE_ID_STORAGE_KEY = "gemini_api_key_active_id_v1";
        const PHOTO_RECOMMENDED_MIN = 8;
        const PHOTO_RECOMMENDED_MAX = 20;
        const PHOTO_HARD_MAX = 30;
        const MAX_SINGLE_IMAGE_MB = 20;
        const MAX_TOTAL_IMAGE_PAYLOAD_MB = 18;
        const IMAGE_READ_TIMEOUT_MS = 90000;
        let userImages = [];
        let uploadedImageItems = [];
        let isUploadingFiles = false;
        let currentTab = 'writer';
        let activeToneProfile = null;
        let isExternalRiskPanelOpen = false;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            checkApiKey();
            setupDragAndDrop();
            loadBlogId();
            updateToneStatusFromCache();
            setupCharCounter();
            updateCharCount();
            updatePhotoGuideStatus(0);
            updateSeoScoreBadge(null);
            updateExternalRiskBadge(null);
            resetAssistPanel();
            setExternalRiskPanel(false);
            setPublishPanelMobileOpen(false);

            // Defensive clear to prevent ghost images from browser restoration
            const imgInput = document.getElementById('imageInput');
            if (imgInput) imgInput.value = '';
        });

        window.addEventListener('pageshow', () => {
            // Prevent stale file/input state when page is restored from bfcache.
            resetUploadState();
            setExternalRiskPanel(false);
            setPublishPanelMobileOpen(false);
        });

        // --- Tab Logic ---
        function switchTab(tabName) {
            currentTab = tabName;
            const writerView = document.getElementById('view-writer');
            const managerView = document.getElementById('view-manager');
            const writerTab = document.getElementById('tab-writer');
            const managerTab = document.getElementById('tab-manager');

            if (tabName === 'writer') {
                writerView.classList.remove('hidden');
                setTimeout(() => writerView.classList.remove('opacity-0'), 10);
                managerView.classList.add('opacity-0');
                setTimeout(() => managerView.classList.add('hidden'), 300);

                writerTab.className = 'pb-3 px-1 transition-all tab-active';
                managerTab.className = 'pb-3 px-1 transition-all tab-inactive';
            } else {
                managerView.classList.remove('hidden');
                setTimeout(() => managerView.classList.remove('opacity-0'), 10);
                writerView.classList.add('opacity-0');
                setTimeout(() => writerView.classList.add('hidden'), 300);

                writerTab.className = 'pb-3 px-1 transition-all tab-inactive';
                managerTab.className = 'pb-3 px-1 transition-all tab-active';
            }
        }

        // --- Drag & Drop ---
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, preventDefaults, false));
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('border-pink-500', 'bg-pink-50', 'scale-[1.02]'), false));
            ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('border-pink-500', 'bg-pink-50', 'scale-[1.02]'), false));
            dropZone.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;

            if (dt && dt.files && dt.files.length > 0) {
                handleFiles(dt.files);
                return;
            }

            if (dt && dt.items && dt.items.length > 0) {
                const fallbackFiles = Array.from(dt.items)
                    .filter(item => item.kind === 'file')
                    .map(item => item.getAsFile())
                    .filter(Boolean);
                handleFiles(fallbackFiles);
                return;
            }

            handleFiles([]);
        }

        function handleImageSelect(e) {
            const files = e?.target?.files || [];
            handleFiles(files);
            if (e?.target) e.target.value = '';
        }

        function clearAllImages() {
            if (uploadedImageItems.length === 0) return;
            if (!confirm('ì—…ë¡œë“œëœ ëª¨ë“  ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            resetUploadState();
        }

        function isImageLikeFile(file) {
            if (!file) return false;
            if (file.type && file.type.startsWith('image/')) return true;
            return /\.(png|jpe?g|gif|webp|bmp|heic|heif|avif|jfif|tiff?|svg)$/i.test(file.name || '');
        }

        function isHeicLikeFile(file) {
            if (!file) return false;
            const type = (file.type || '').toLowerCase();
            if (type === 'image/heic' || type === 'image/heif' || type === 'image/heic-sequence' || type === 'image/heif-sequence') {
                return true;
            }
            return /\.(heic|heif)$/i.test(file.name || '');
        }

        function getMimeTypeFromFile(file, dataUrl) {
            if (file && file.type && file.type.startsWith('image/')) return file.type;

            const ext = ((file && file.name) || '').toLowerCase().split('.').pop();
            const extMap = {
                jpg: 'image/jpeg',
                jpeg: 'image/jpeg',
                jfif: 'image/jpeg',
                png: 'image/png',
                webp: 'image/webp',
                gif: 'image/gif',
                bmp: 'image/bmp',
                tif: 'image/tiff',
                tiff: 'image/tiff',
                svg: 'image/svg+xml',
                avif: 'image/avif',
                heic: 'image/jpeg',
                heif: 'image/jpeg'
            };
            if (extMap[ext]) return extMap[ext];

            const match = /^data:(image\/[a-z0-9.+-]+);base64,/i.exec(dataUrl || '');
            if (match) return match[1];
            return 'image/jpeg';
        }

        function extractBlobFromHeicResult(converted) {
            if (!converted) return null;
            if (converted instanceof Blob) return converted;
            if (Array.isArray(converted)) {
                for (const item of converted) {
                    if (item instanceof Blob) return item;
                }
            }
            return null;
        }

        const HEIC_CONVERT_TIMEOUT_MS = 15000;

        async function convertHeicFile(file) {
            if (!isHeicLikeFile(file)) return file;
            if (typeof heic2any !== 'function') {
                throw new Error('HEIC ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
            }

            // Lowered quality slightly for better success rate
            const attempts = [
                { toType: 'image/jpeg', quality: 0.70, ext: 'jpg' },
                { toType: 'image/jpeg', quality: 0.50, ext: 'jpg' },
                { toType: 'image/png', quality: 0.8, ext: 'png' }
            ];

            let lastError = null;

            const convertWithTimeout = (options) => {
                return new Promise((resolve, reject) => {
                    const timer = setTimeout(() => reject(new Error('HEIC ë³€í™˜ ì‹œê°„ ì´ˆê³¼')), HEIC_CONVERT_TIMEOUT_MS);
                    heic2any(options)
                        .then(res => { clearTimeout(timer); resolve(res); })
                        .catch(err => { clearTimeout(timer); reject(err); });
                });
            };

            for (const attempt of attempts) {
                try {
                    const converted = await convertWithTimeout({
                        blob: file,
                        toType: attempt.toType,
                        quality: attempt.quality
                    });

                    const blob = extractBlobFromHeicResult(converted);
                    if (!blob || blob.size === 0) {
                        throw new Error('ë³€í™˜ ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤');
                    }

                    const outType = blob.type && blob.type.startsWith('image/')
                        ? blob.type
                        : attempt.toType;
                    const outName = (file.name || 'image').replace(/\.(heic|heif)$/i, '.' + attempt.ext);

                    return new File([blob], outName, {
                        type: outType,
                        lastModified: file.lastModified || Date.now()
                    });
                } catch (err) {
                    lastError = err;
                    console.warn(`HEIC conversion attempt failed (${attempt.toType}, q=${attempt.quality})`, err);
                }
            }

            throw lastError || new Error('HEIC ë³€í™˜ ì‹¤íŒ¨ (ëª¨ë“  ì‹œë„ ì—ëŸ¬)');
        }

        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const timer = setTimeout(() => {
                    try { reader.abort(); } catch (e) { /* no-op */ }
                    reject(new Error('íŒŒì¼ ì½ê¸° ì‹œê°„ ì´ˆê³¼'));
                }, IMAGE_READ_TIMEOUT_MS);

                reader.onload = (e) => {
                    clearTimeout(timer);
                    resolve((e?.target?.result || '').toString());
                };

                reader.onerror = () => {
                    clearTimeout(timer);
                    reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                };

                reader.onabort = () => {
                    clearTimeout(timer);
                    reject(new Error('íŒŒì¼ ì½ê¸° ì¤‘ë‹¨'));
                };

                try {
                    reader.readAsDataURL(file);
                } catch (err) {
                    clearTimeout(timer);
                    reject(err);
                }
            });
        }

        async function readFileAsDataUrlSafe(file) {
            try {
                return await readFileAsDataUrl(file);
            } catch (firstErr) {
                try {
                    const buffer = await file.arrayBuffer();
                    const bytes = new Uint8Array(buffer);
                    const chunkSize = 0x8000;
                    let binary = '';

                    for (let i = 0; i < bytes.length; i += chunkSize) {
                        const chunk = bytes.subarray(i, i + chunkSize);
                        binary += String.fromCharCode(...chunk);
                    }

                    const mime = (file.type && file.type.startsWith('image/')) ? file.type : 'image/jpeg';
                    return `data:${mime};base64,${btoa(binary)}`;
                } catch (fallbackErr) {
                    console.error('ArrayBuffer fallback failed', fallbackErr, firstErr);
                    throw firstErr;
                }
            }
        }

        function resetUploadState() {
            userImages = [];
            uploadedImageItems = [];
            isUploadingFiles = false;

            const container = document.getElementById('imagePreview');
            if (container) container.innerHTML = '';

            const imageInput = document.getElementById('imageInput');
            if (imageInput) imageInput.value = '';

            updatePhotoGuideStatus(0);
        }

        function syncUserImagesFromUploadedItems() {
            userImages = uploadedImageItems.map(item => ({
                inlineData: {
                    data: item.inlineData.data,
                    mimeType: item.inlineData.mimeType
                }
            }));
            updatePhotoGuideStatus(userImages.length);
        }

        function renderImagePreview() {
            const container = document.getElementById('imagePreview');
            if (!container) return;

            container.innerHTML = uploadedImageItems.map((item, idx) => `
                <div class="relative aspect-square rounded-lg overflow-hidden border border-gray-200 animate-fade-in">
                    <img src="${item.previewUrl}" class="w-full h-full object-cover">
                    <span class="absolute top-1 right-1 bg-black/50 text-white text-[10px] px-1.5 rounded-full">${idx + 1}</span>
                    <button type="button"
                        class="absolute top-1 left-1 w-5 h-5 rounded-full bg-white/90 text-gray-800 text-[11px] font-bold hover:bg-white"
                        onclick="removeImageAt(${idx})"
                        aria-label="remove image">X</button>
                </div>
            `).join('');
        }

        function removeImageAt(index) {
            if (index < 0 || index >= uploadedImageItems.length) return;
            uploadedImageItems.splice(index, 1);
            syncUserImagesFromUploadedItems();
            renderImagePreview();
        }

        async function handleFiles(files) {
            const fileArray = Array.from(files || []).filter(Boolean);
            if (fileArray.length === 0) return;

            if (isUploadingFiles) {
                alert('ì´ì „ ì‚¬ì§„ ì—…ë¡œë“œë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const currentCount = uploadedImageItems.length;
            if (currentCount >= PHOTO_HARD_MAX) {
                alert('ì´ë¯¸ ìµœëŒ€ ' + PHOTO_HARD_MAX + 'ì¥ì´ ì—…ë¡œë“œë˜ì–´ ìˆìŠµë‹ˆë‹¤. í•„ìš” ì—†ëŠ” ì‚¬ì§„ì„ Xë¡œ ì‚­ì œí•œ ë’¤ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }

            isUploadingFiles = true;
            showLoading(true, "ì‚¬ì§„ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...");

            try {
                const imageCandidates = fileArray.filter(isImageLikeFile);
                if (imageCandidates.length === 0) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const remainingSlots = PHOTO_HARD_MAX - uploadedImageItems.length;
                const selectedFiles = imageCandidates.slice(0, remainingSlots);
                const maxBytes = MAX_SINGLE_IMAGE_MB * 1024 * 1024;
                let skippedTooLarge = 0;
                let skippedReadError = 0;
                let skippedHeicConvert = 0;
                let skippedPayloadLimit = 0;
                let addedCount = 0;
                let readFailMaxMb = 0;
                let convertFailMaxMb = 0;

                if (imageCandidates.length > remainingSlots) {
                    alert('ìµœëŒ€ ' + PHOTO_HARD_MAX + 'ì¥ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ë²ˆì—ëŠ” ' + selectedFiles.length + 'ì¥ë§Œ ì¶”ê°€ë©ë‹ˆë‹¤.');
                }

                for (let i = 0; i < selectedFiles.length; i++) {
                    let file = selectedFiles[i];
                    if (!file) continue;

                    if (file.size > maxBytes) {
                        skippedTooLarge += 1;
                        continue;
                    }

                    // Handle HEIC/HEIF
                    if (isHeicLikeFile(file)) {
                        try {
                            file = await convertHeicFile(file);
                        } catch (e) {
                            console.error("HEIC conversion failed", e);
                            skippedHeicConvert += 1;
                            convertFailMaxMb = Math.max(convertFailMaxMb, Number(file.size || 0) / (1024 * 1024));
                            continue;
                        }
                    }

                    if (!isImageLikeFile(file)) continue;

                    if (file.size > maxBytes) {
                        skippedTooLarge += 1;
                        continue;
                    }

                    try {
                        const dataUrl = await readFileAsDataUrlSafe(file);
                        const base64 = (dataUrl || '').toString().split(',')[1];
                        if (!base64) {
                            skippedReadError += 1;
                            continue;
                        }

                        const nextSizeBytes = Math.floor(base64.length * 0.75);
                        const totalPayloadAfterAdd = getCurrentImagePayloadBytes() + nextSizeBytes;
                        const payloadLimitBytes = MAX_TOTAL_IMAGE_PAYLOAD_MB * 1024 * 1024;
                        if (totalPayloadAfterAdd > payloadLimitBytes) {
                            skippedPayloadLimit += 1;
                            continue;
                        }

                        uploadedImageItems.push({
                            inlineData: {
                                data: base64,
                                mimeType: getMimeTypeFromFile(file, dataUrl)
                            },
                            previewUrl: dataUrl
                        });
                        addedCount += 1;
                    } catch (e) {
                        console.error('Image read failed', e);
                        skippedReadError += 1;
                        readFailMaxMb = Math.max(readFailMaxMb, Number(file.size || 0) / (1024 * 1024));
                    }
                }

                syncUserImagesFromUploadedItems();
                renderImagePreview();

                if (skippedTooLarge > 0 || skippedHeicConvert > 0 || skippedReadError > 0 || skippedPayloadLimit > 0) {
                    let msg = '';
                    if (skippedTooLarge > 0) msg += 'ìš©ëŸ‰ ì´ˆê³¼(' + MAX_SINGLE_IMAGE_MB + 'MB) ' + skippedTooLarge + 'ì¥';
                    if (skippedHeicConvert > 0) {
                        msg += (msg ? ', ' : '') + 'HEIC ë³€í™˜ ì‹¤íŒ¨ ' + skippedHeicConvert + 'ì¥';
                        if (convertFailMaxMb > 0) msg += ' (ìµœëŒ€ ì•½ ' + convertFailMaxMb.toFixed(1) + 'MB)';
                    }
                    if (skippedReadError > 0) {
                        msg += (msg ? ', ' : '') + 'ì½ê¸° ì‹¤íŒ¨ ' + skippedReadError + 'ì¥';
                        if (readFailMaxMb > 0) msg += ' (ìµœëŒ€ ì•½ ' + readFailMaxMb.toFixed(1) + 'MB)';
                    }
                    if (skippedPayloadLimit > 0) {
                        msg += (msg ? ', ' : '') + 'ì „ì†¡ í•œë„ ì´ˆê³¼ ' + skippedPayloadLimit + 'ì¥';
                        msg += ` (ì´ ì´ë¯¸ì§€ ë°ì´í„° ${MAX_TOTAL_IMAGE_PAYLOAD_MB}MB ì œí•œ)`;
                    }
                    if (addedCount === 0) {
                        alert('ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤. ' + msg);
                    } else {
                        alert('ì¼ë¶€ ì‚¬ì§„ì´ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤: ' + msg);
                    }
                }
            } catch (error) {
                alert('ì‚¬ì§„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                isUploadingFiles = false;
                showLoading(false);
                const imageInput = document.getElementById('imageInput');
                if (imageInput) imageInput.value = '';
            }
        }

        function updatePhotoGuideStatus(count) {
            const statusEl = document.getElementById('photoGuideStatus');
            if (!statusEl) return;

            let msg = 'ì„ íƒ ' + count + 'ì¥ Â· ê¶Œì¥ ' + PHOTO_RECOMMENDED_MIN + '~' + PHOTO_RECOMMENDED_MAX + 'ì¥ Â· ìµœëŒ€ ' + PHOTO_HARD_MAX + 'ì¥';
            let cls = 'font-semibold text-gray-700 mb-2';

            if (count === 0) {
                msg = 'ì„ íƒ 0ì¥ Â· ê¶Œì¥ ' + PHOTO_RECOMMENDED_MIN + '~' + PHOTO_RECOMMENDED_MAX + 'ì¥ Â· ìµœëŒ€ ' + PHOTO_HARD_MAX + 'ì¥';
            } else if (count < PHOTO_RECOMMENDED_MIN) {
                msg += ' (ì¡°ê¸ˆ ë” ì˜¬ë¦¬ë©´ ì •í™•ë„ê°€ ì¢‹ì•„ì ¸ìš”)';
                cls = 'font-semibold text-amber-600 mb-2';
            } else if (count <= PHOTO_RECOMMENDED_MAX) {
                msg += ' (ì¢‹ì€ êµ¬ì„±ì…ë‹ˆë‹¤)';
                cls = 'font-semibold text-emerald-600 mb-2';
            } else if (count <= PHOTO_HARD_MAX) {
                msg += ' (ë§ì€ í¸ì…ë‹ˆë‹¤. í•µì‹¬ ì‚¬ì§„ ìœ„ì£¼ë¡œ ì •ë¦¬í•´ë³´ì„¸ìš”)';
                cls = 'font-semibold text-orange-600 mb-2';
            } else {
                msg += ' (ì²˜ìŒ ' + PHOTO_HARD_MAX + 'ì¥ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤)';
                cls = 'font-semibold text-red-600 mb-2';
            }

            statusEl.className = cls;
            statusEl.textContent = msg;
        }

        function getCurrentImagePayloadBytes() {
            return uploadedImageItems.reduce((sum, item) => {
                const base64 = item?.inlineData?.data || '';
                return sum + Math.floor(base64.length * 0.75);
            }, 0);
        }

        function escapeRegExp(value) {
            return (value || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function parseKeywordList(raw) {
            return (raw || '')
                .split(/[,/\n]/)
                .map(v => v.trim())
                .filter(Boolean)
                .filter((v, idx, arr) => arr.indexOf(v) === idx)
                .slice(0, 12);
        }

        function extractKeywordCandidatesFromText(text, limit = 8) {
            const stopWords = new Set([
                'ì˜¤ëŠ˜', 'ì´ë²ˆ', 'ì •ë§', 'ì§„ì§œ', 'í›„ê¸°', 'ì¶”ì²œ', 'ë°©ë¬¸', 'ë¦¬ë·°', 'ì‚¬ìš©', 'ì‚¬ì§„', 'ì‘ì„±', 'ë‚´ìš©', 'ì •ë¦¬',
                'ê·¸ë¦¬ê³ ', 'ê·¸ë˜ì„œ', 'ê·¸ëƒ¥', 'ì €ëŠ”', 'ì €í¬', 'ìš°ë¦¬', 'í•©ë‹ˆë‹¤', 'ìˆì–´ìš”', 'ì…ë‹ˆë‹¤'
            ]);
            const cleaned = (text || '').replace(/[^\uAC00-\uD7A3a-zA-Z0-9\s]/g, ' ');
            const tokens = cleaned.split(/\s+/).filter(Boolean);
            const counts = new Map();

            for (const token of tokens) {
                if (token.length < 2) continue;
                if (/^\d+$/.test(token)) continue;
                if (stopWords.has(token)) continue;
                counts.set(token, (counts.get(token) || 0) + 1);
            }

            return [...counts.entries()]
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([word]) => word);
        }

        function getWriterContext() {
            const topic = (document.getElementById('topicInput')?.value || '').trim();
            const targetReaderRaw = (document.getElementById('targetReaderInput')?.value || '').trim();
            const manualKeywords = parseKeywordList(document.getElementById('mainKeywordInput')?.value || '');
            const fallbackKeywords = extractKeywordCandidatesFromText(topic, 8);

            return {
                topic,
                targetReader: targetReaderRaw || 'ì¼ë°˜ ë…ì',
                manualKeywords,
                effectiveKeywords: manualKeywords.length ? manualKeywords : fallbackKeywords
            };
        }

        function setAssistStatus(message, isError = false) {
            const el = document.getElementById('assistStatus');
            if (!el) return;
            el.textContent = message;
            el.className = `text-[11px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
        }

        function setAssistContentMarkdown(markdownText, statusMessage, isError = false) {
            const el = document.getElementById('assistContent');
            if (!el) return;
            el.innerHTML = marked.parse(markdownText || '');
            setAssistStatus(statusMessage, isError);
        }

        function resetAssistPanel() {
            const el = document.getElementById('assistContent');
            if (!el) return;
            el.innerHTML = '<p>1~3ë‹¨ê³„ ì ê²€ í›„ 4ë²ˆ ë²„íŠ¼ìœ¼ë¡œ ì™¸ë¶€ ë¦¬ìŠ¤í¬ë¥¼ ì ê²€í•˜ê³ , ë§ˆì§€ë§‰ì— <strong>5. ë°œí–‰ ìš”ì†Œ ìƒì„±</strong>ì„ ì‹¤í–‰í•˜ì„¸ìš”.</p>';
            setAssistStatus('ì•„ì§ ìƒì„± ì „');
        }

        function updateSeoScoreBadge(score) {
            const badge = document.getElementById('seoScoreBadge');
            if (!badge) return;

            if (score === null || score === undefined || Number.isNaN(score)) {
                badge.textContent = '3ë‹¨ê³„ ì ê²€ ì „';
                badge.className = 'text-[11px] text-gray-400';
                return;
            }

            const safeScore = Math.max(0, Math.min(100, Math.round(score)));
            if (safeScore >= 85) {
                badge.textContent = `ë¡œì»¬ ë…¸ì¶œ ì ìˆ˜ ${safeScore}ì  (ì–‘í˜¸)`;
                badge.className = 'text-[11px] text-emerald-600';
            } else if (safeScore >= 70) {
                badge.textContent = `ë¡œì»¬ ë…¸ì¶œ ì ìˆ˜ ${safeScore}ì  (ë³´ì™„ ê¶Œì¥)`;
                badge.className = 'text-[11px] text-amber-600';
            } else {
                badge.textContent = `ë¡œì»¬ ë…¸ì¶œ ì ìˆ˜ ${safeScore}ì  (ê°œì„  í•„ìš”)`;
                badge.className = 'text-[11px] text-rose-600';
            }
        }

        function updateExternalRiskBadge(score) {
            const badge = document.getElementById('externalRiskBadge');
            if (!badge) return;

            if (score === null || score === undefined || Number.isNaN(score)) {
                badge.textContent = '4ë‹¨ê³„ ì ê²€ ì „';
                badge.className = 'text-[11px] text-gray-400';
                return;
            }

            const safeScore = Math.max(0, Math.min(100, Math.round(score)));
            if (safeScore <= 39) {
                badge.textContent = `ì™¸ë¶€ ë¦¬ìŠ¤í¬ ${safeScore}ì  (ë‚®ìŒ)`;
                badge.className = 'text-[11px] text-emerald-600';
            } else if (safeScore <= 69) {
                badge.textContent = `ì™¸ë¶€ ë¦¬ìŠ¤í¬ ${safeScore}ì  (ë³´í†µ)`;
                badge.className = 'text-[11px] text-amber-600';
            } else {
                badge.textContent = `ì™¸ë¶€ ë¦¬ìŠ¤í¬ ${safeScore}ì  (ë†’ìŒ)`;
                badge.className = 'text-[11px] text-rose-600';
            }
        }

        function scrollToExternalRiskPanel() {
            const panel = document.getElementById('externalRiskPanel');
            if (!panel || panel.classList.contains('hidden')) return;

            const scrollArea = document.getElementById('writerControlsScroll');
            const scrollAction = () => {
                if (scrollArea) {
                    const panelTop = panel.offsetTop;
                    const targetTop = Math.max(panelTop - 12, 0);
                    scrollArea.scrollTo({ top: targetTop, behavior: 'smooth' });
                } else {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                panel.classList.add('ring-2', 'ring-pink-200');
                window.setTimeout(() => {
                    panel.classList.remove('ring-2', 'ring-pink-200');
                }, 900);
            };

            requestAnimationFrame(() => requestAnimationFrame(scrollAction));
        }

        function setExternalRiskPanel(open) {
            const panel = document.getElementById('externalRiskPanel');
            const label = document.getElementById('externalRiskButtonLabel');
            if (!panel || !label) return;

            isExternalRiskPanelOpen = Boolean(open);

            if (isExternalRiskPanelOpen) {
                panel.classList.remove('hidden');
                scrollToExternalRiskPanel();
                label.textContent = 'ğŸŒ¤ï¸ 4. ì™¸ë¶€ í™˜ê²½ ë¦¬ìŠ¤í¬ ì ê²€ ì‹¤í–‰';
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('ring-2', 'ring-pink-200');
                label.textContent = 'ğŸŒ¤ï¸ 4. ì™¸ë¶€ í™˜ê²½ ë¦¬ìŠ¤í¬ ì ê²€';
            }
        }

        function hideExternalRiskPanel() {
            setExternalRiskPanel(false);
            setAssistStatus('4ë‹¨ê³„ ì˜µì…˜ ë‹«í˜');
        }

        function onExternalRiskButtonClick() {
            if (!isExternalRiskPanelOpen) {
                setExternalRiskPanel(true);
                setAssistStatus('4ë‹¨ê³„ ì˜µì…˜ ì—´ë¦¼: ê°’ í™•ì¸ í›„ 4ë²ˆ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ì„¸ìš”.');
                return;
            }
            runExternalRiskCheck();
        }

        function runLocalSeoCheck() {
            const draft = getOutputTextForCount().trim();
            const { topic, effectiveKeywords, targetReader } = getWriterContext();

            if (!topic && draft.length < 80) {
                alert('ì£¼ì œ ë˜ëŠ” ì´ˆì•ˆì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ì´ˆì•ˆì„ ë§Œë“¤ê±°ë‚˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let score = 100;
            const actionItems = [];

            const bodyLength = draft.length;
            const paragraphCount = draft ? draft.split(/\n{2,}/).map(v => v.trim()).filter(Boolean).length : 0;
            const topicSignals = new Set(
                [
                    ...effectiveKeywords.map(v => v.toLowerCase()),
                    ...extractKeywordCandidatesFromText(topic, 20).map(v => v.toLowerCase())
                ].filter(Boolean)
            );
            const keywordStats = effectiveKeywords.map(keyword => {
                const matches = draft.match(new RegExp(escapeRegExp(keyword), 'gi'));
                return { keyword, count: matches ? matches.length : 0 };
            });
            const usedKeywordCount = keywordStats.filter(item => item.count > 0).length;

            if (bodyLength < 1200) {
                score -= 18;
                actionItems.push('ë³¸ë¬¸ì´ ì§§ì€ í¸ì…ë‹ˆë‹¤. í•µì‹¬ ê²½í—˜/ì •ë³´ ë¬¸ë‹¨ì„ 1~2ê°œ ì¶”ê°€í•´ë³´ì„¸ìš”.');
            } else if (bodyLength > 7000) {
                score -= 6;
                actionItems.push('ë³¸ë¬¸ì´ ê¸´ í¸ì…ë‹ˆë‹¤. ë°˜ë³µ ë¬¸ì¥ì„ ì¤„ì—¬ ê°€ë…ì„±ì„ ì˜¬ë ¤ë³´ì„¸ìš”.');
            }

            if (paragraphCount > 0 && paragraphCount < 4) {
                score -= 14;
                actionItems.push('ë¬¸ë‹¨ ìˆ˜ê°€ ì ìŠµë‹ˆë‹¤. ì†Œì œëª© ë˜ëŠ” ë¬¸ë‹¨ ë¶„ë¦¬ë¡œ ì½ê¸° íë¦„ì„ ê°œì„ í•˜ì„¸ìš”.');
            }

            if (effectiveKeywords.length > 0) {
                const minTarget = Math.min(3, effectiveKeywords.length);
                if (usedKeywordCount < minTarget) {
                    score -= 20;
                    actionItems.push('í•µì‹¬ í‚¤ì›Œë“œ ë°˜ì˜ì´ ì•½í•©ë‹ˆë‹¤. ë„ì…/ì¤‘ê°„/ë§ˆë¬´ë¦¬ì— ìì—°ìŠ¤ëŸ½ê²Œ ë¶„ì‚° ë°°ì¹˜í•˜ì„¸ìš”.');
                }

                const overRepeated = keywordStats.filter(item => item.count >= 7);
                if (overRepeated.length > 0) {
                    score -= 10;
                    actionItems.push('ì¼ë¶€ í‚¤ì›Œë“œ ë°˜ë³µì´ ê³¼í•©ë‹ˆë‹¤. ìœ ì˜ì–´ë¥¼ ì„ê³  ë¶ˆí•„ìš” ë°˜ë³µì„ ì¤„ì´ì„¸ìš”.');
                }
            } else {
                score -= 8;
                actionItems.push('í•µì‹¬ í‚¤ì›Œë“œê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì‘ì„± ë³´ì¡° ì •ë³´ì— ìš°ì„  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.');
            }

            const hypeMatches = draft.match(/(ìµœê³ |ë¬´ì¡°ê±´|1ë“±|1ìœ„|ì ˆëŒ€|ì—­ëŒ€ê¸‰|ì™„ë²½|í•„ìˆ˜êµ¬ë§¤)/gi) || [];
            if (hypeMatches.length >= 2) {
                score -= 12;
                actionItems.push('ê³¼ì¥ í‘œí˜„ì´ ë§ì€ í¸ì…ë‹ˆë‹¤. ì‹ ë¢°í˜• ë¬¸ì¥ìœ¼ë¡œ ì¡°ì •í•˜ì„¸ìš”.');
            }

            const spamBaitTerms = ['ëŒ€ì¶œ', 'ì½”ì¸', 'íˆ¬ì', 'ì£¼ì‹', 'ì¹´ì§€ë…¸', 'ì„±í˜•', 'ë‹¤ì´ì–´íŠ¸', 'ë³´í—˜'];
            const unrelatedTerms = spamBaitTerms.filter(term =>
                draft.includes(term) && !topic.includes(term) && !effectiveKeywords.some(k => k.includes(term))
            );
            if (unrelatedTerms.length > 0) {
                score -= 12;
                actionItems.push(`ë¬´ê´€ í‚¤ì›Œë“œ ì˜ì‹¬ í‘œí˜„(${unrelatedTerms.join(', ')})ì´ ë³´ì…ë‹ˆë‹¤. ì£¼ì œ ê´€ë ¨ í‘œí˜„ë§Œ ë‚¨ê¸°ì„¸ìš”.`);
            }

            const hashtags = (draft.match(/#[ê°€-í£a-zA-Z0-9_]+/g) || []).map(tag => tag.replace(/^#/, '').toLowerCase());
            const unrelatedHashtags = hashtags.filter(tag => {
                if (!tag) return false;
                if (topicSignals.has(tag)) return false;
                return ![...topicSignals].some(signal =>
                    signal.length >= 2 && (tag.includes(signal) || signal.includes(tag))
                );
            });
            if (hashtags.length > 0 && unrelatedHashtags.length >= Math.max(2, Math.ceil(hashtags.length * 0.4))) {
                score -= 10;
                actionItems.push('í•´ì‹œíƒœê·¸ ì¤‘ ë¬´ê´€ íƒœê·¸ ë¹„ì¤‘ì´ ë†’ìŠµë‹ˆë‹¤. ë³¸ë¬¸ í•µì‹¬ ì£¼ì œ ê¸°ë°˜ íƒœê·¸ë¡œ ì •ë¦¬í•˜ì„¸ìš”.');
            }

            if (draft && !/[0-9]/.test(draft)) {
                score -= 6;
                actionItems.push('ê°€ê²©/ì‹œê°„/ê±°ë¦¬ ê°™ì€ ìˆ˜ì¹˜ ì •ë³´ê°€ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹ ë¢° í¬ì¸íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.');
            }

            score = Math.max(0, Math.min(100, score));
            updateSeoScoreBadge(score);

            const keywordLines = keywordStats.length
                ? keywordStats.map(item => `- ${item.keyword}: ${item.count}íšŒ`).join('\n')
                : '- (í‚¤ì›Œë“œ ì—†ìŒ)';
            const hashtagSummary = hashtags.length
                ? `- ì´ ${hashtags.length}ê°œ / ë¬´ê´€ ì˜ì‹¬ ${unrelatedHashtags.length}ê°œ`
                : '- í•´ì‹œíƒœê·¸ ì—†ìŒ';
            const hypeSummary = hypeMatches.length
                ? `- ê³¼ì¥ í‘œí˜„ ${hypeMatches.length}íšŒ`
                : '- ê³¼ì¥ í‘œí˜„ ì—†ìŒ';

            const actionText = actionItems.length
                ? actionItems.map((item, idx) => `${idx + 1}. ${item}`).join('\n')
                : '1. í˜„ì¬ êµ¬ì„±ì€ ì „ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì…ë‹ˆë‹¤. ê²Œì‹œ ì „ ì‚¬ì‹¤/í‘œê¸°ë§Œ ìµœì¢… í™•ì¸í•˜ì„¸ìš”.';

            const markdown = `
### 3. ë…¸ì¶œ ê°€ëŠ¥ì„± ì ê²€ ê²°ê³¼: ${score}ì 
- íƒ€ê¹ƒ ë…ì: ${targetReader}
- ë³¸ë¬¸ ê¸¸ì´: ${bodyLength}ì
- ë¬¸ë‹¨ ìˆ˜: ${paragraphCount}ê°œ
- í‚¤ì›Œë“œ ì‚¬ìš© í‚¤: ${usedKeywordCount}/${effectiveKeywords.length}

#### í‚¤ì›Œë“œ ì‚¬ìš© í˜„í™©
${keywordLines}

#### í’ˆì§ˆ ì‹ í˜¸
${hashtagSummary}
${hypeSummary}

#### ë°”ë¡œ ë³´ì™„í•  ì 
${actionText}
            `;

            setAssistContentMarkdown(markdown, `3ë‹¨ê³„ ì ê²€ ì™„ë£Œ (${score}ì )`);
        }

        function runExternalRiskCheck() {
            if (!isExternalRiskPanelOpen) {
                setExternalRiskPanel(true);
            }

            const factors = [
                { id: 'riskCompetitionInput', label: 'í‚¤ì›Œë“œ ê²½ìŸë„', weight: 0.35 },
                { id: 'riskSeasonalityInput', label: 'ì‹œì¦Œì„±', weight: 0.20 },
                { id: 'riskSaturationInput', label: 'ì£¼ì œ í¬í™”ë„', weight: 0.20 },
                { id: 'riskTimingInput', label: 'ë°œí–‰ íƒ€ì´ë°', weight: 0.15 },
                { id: 'riskActivityInput', label: 'ìµœê·¼ í™œë™ì„±', weight: 0.10 }
            ];

            let riskScore = 0;
            const detailLines = [];
            const actions = [];

            for (const factor of factors) {
                const el = document.getElementById(factor.id);
                const val = Number(el?.value || 55);
                const safeVal = Number.isFinite(val) ? Math.max(0, Math.min(100, val)) : 55;
                riskScore += safeVal * factor.weight;
                detailLines.push(`- ${factor.label}: ${Math.round(safeVal)}ì `);

                if (safeVal >= 80) {
                    if (factor.id === 'riskCompetitionInput') {
                        actions.push('ê²½ìŸë„ê°€ ë†’ìŠµë‹ˆë‹¤. ì„¸ë¶€ í‚¤ì›Œë“œ(ì§€ì—­/ìƒí™©/ëŒ€ìƒ)ë¥¼ ë” êµ¬ì²´í™”í•˜ì„¸ìš”.');
                    } else if (factor.id === 'riskSeasonalityInput') {
                        actions.push('ì‹œì¦Œì„±ì´ ë‚®ìŠµë‹ˆë‹¤. í˜„ì¬ ì‹œì ê³¼ ì—°ê²°ë˜ëŠ” ìˆ˜ìš” í¬ì¸íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
                    } else if (factor.id === 'riskSaturationInput') {
                        actions.push('ì£¼ì œ í¬í™”ë„ê°€ ë†’ìŠµë‹ˆë‹¤. ë¹„êµ ê¸°ì¤€ì´ë‚˜ ê°œì¸ ê²½í—˜ í¬ì¸íŠ¸ë¥¼ ë” ë¶„ëª…íˆ ì“°ì„¸ìš”.');
                    } else if (factor.id === 'riskTimingInput') {
                        actions.push('ë°œí–‰ íƒ€ì´ë°ì´ ì•„ì‰½ìŠµë‹ˆë‹¤. ë°©ë¬¸ì í™œë™ ì‹œê°„ëŒ€ì— ë§ì¶° ì˜ˆì•½ ë°œí–‰ì„ ê²€í† í•˜ì„¸ìš”.');
                    } else if (factor.id === 'riskActivityInput') {
                        actions.push('ìµœê·¼ í™œë™ì„±ì´ ë‚®ìŠµë‹ˆë‹¤. ë°œí–‰ ì£¼ê¸° ì•ˆì •í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    }
                }
            }

            riskScore = Math.round(Math.max(0, Math.min(100, riskScore)));
            updateExternalRiskBadge(riskScore);

            let bandText = 'ë³´í†µ';
            if (riskScore <= 39) bandText = 'ë‚®ìŒ';
            else if (riskScore >= 70) bandText = 'ë†’ìŒ';

            const actionText = actions.length
                ? actions.map((item, idx) => `${idx + 1}. ${item}`).join('\n')
                : '1. ì™¸ë¶€ ë¦¬ìŠ¤í¬ëŠ” ë¹„êµì  ì•ˆì •ì ì…ë‹ˆë‹¤. ë‚´ë¶€ í’ˆì§ˆ ì ê²€ ê²°ê³¼ë¥¼ ìš°ì„  ë°˜ì˜í•˜ì„¸ìš”.';

            const markdown = `
### 4. ì™¸ë¶€ í™˜ê²½ ë¦¬ìŠ¤í¬ ì ê²€ ê²°ê³¼: ${riskScore}ì  (${bandText})
${detailLines.join('\n')}

#### ëŒ€ì‘ ê°€ì´ë“œ
${actionText}
            `;

            setAssistContentMarkdown(markdown, `ì™¸ë¶€ ë¦¬ìŠ¤í¬ ì ê²€ ì™„ë£Œ (${riskScore}ì )`);
        }

        function getOutputTextForCount() {
            const output = document.getElementById('outputContent');
            if (!output) return '';

            // The initial placeholder block is decorative and should not count.
            if (output.querySelector('.select-none')) return '';

            return output.innerText || '';
        }

        function updateCharCount() {
            const text = getOutputTextForCount();
            const withSpace = text.length;
            const withoutSpace = text.replace(/\s/g, '').length;

            const withSpaceEl = document.getElementById('charCountWithSpace');
            const withoutSpaceEl = document.getElementById('charCountWithoutSpace');
            if (withSpaceEl) withSpaceEl.textContent = String(withSpace);
            if (withoutSpaceEl) withoutSpaceEl.textContent = String(withoutSpace);
        }

        function setupCharCounter() {
            const output = document.getElementById('outputContent');
            if (!output) return;

            output.addEventListener('input', updateCharCount);
            output.addEventListener('keyup', updateCharCount);
            output.addEventListener('paste', () => setTimeout(updateCharCount, 0));

            const observer = new MutationObserver(() => updateCharCount());
            observer.observe(output, { childList: true, subtree: true, characterData: true });
        }

        function normalizeBlogId(inputVal) {
            let value = (inputVal || '').trim();
            if (!value) return '';

            value = value.replace(/^https?:\/\//i, '');

            if (value.includes('blog.naver.com/')) {
                const parts = value.split('blog.naver.com/');
                if (parts[1]) value = parts[1];
            }

            value = value.split('/')[0].split('?')[0].trim();
            return value;
        }

        function getCurrentBlogId() {
            const fromStorage = localStorage.getItem('naver_blog_id') || '';
            return normalizeBlogId(fromStorage);
        }

        function getInputBlogId() {
            const fromInput = document.getElementById('blogIdInput')?.value || '';
            return normalizeBlogId(fromInput);
        }

        function getToneCacheKey(blogId) {
            return `${TONE_CACHE_PREFIX}${blogId}`;
        }

        function setToneStatus(message, isError = false) {
            const statusEls = document.querySelectorAll('[data-tone-status]');
            if (!statusEls.length) return;

            statusEls.forEach((el) => {
                el.textContent = message;
                el.classList.remove('text-red-500', 'text-gray-500');
                el.classList.add(isError ? 'text-red-500' : 'text-gray-500');
            });
        }

        function cleanRssDescription(raw) {
            if (!raw) return '';
            return raw
                .replace(/<img[^>]*>/gi, ' ')
                .replace(/<[^>]+>/g, ' ')
                .replace(/&nbsp;|&#160;/gi, ' ')
                .replace(/&amp;/gi, '&')
                .replace(/&quot;/gi, '"')
                .replace(/&#39;/gi, "'")
                .replace(/\s+/g, ' ')
                .trim();
        }

        function clipText(text, maxLength = 160) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return `${text.slice(0, maxLength).trim()}...`;
        }

        function countPattern(text, regex) {
            const matched = text.match(regex);
            return matched ? matched.length : 0;
        }

        function extractFrequentTokens(samples) {
            const stopWords = new Set([
                'í›„ê¸°', 'ì¶”ì²œ', 'ë‚´ëˆë‚´ì‚°', 'ì§ì ‘', 'ì‚¬ìš©', 'ë°©ë¬¸', 'ìœ„ì¹˜', 'ë§¤ì¥', 'ë¶„ìœ„ê¸°', 'ë©”ë‰´',
                'ë¦¬ë·°', 'í™ë˜ì—°'
            ]);

            const counts = new Map();
            const sourceText = samples.map(s => `${s.title} ${s.body}`).join(' ');
            const cleaned = sourceText.replace(/[^\uAC00-\uD7A30-9\s]/g, ' ');
            const tokens = cleaned.split(/\s+/).filter(Boolean);

            for (const token of tokens) {
                if (token.length < 2) continue;
                if (/^\d+$/.test(token)) continue;
                if (stopWords.has(token)) continue;
                counts.set(token, (counts.get(token) || 0) + 1);
            }

            return [...counts.entries()]
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(([word]) => word);
        }

        function buildToneProfile(blogId, samples) {
            const combinedText = samples.map(s => s.body).join(' ');
            const introRate = samples.filter(s => /^ì•ˆë…•í•˜ì„¸ìš”/.test(s.body)).length / Math.max(samples.length, 1);
            const firstPersonCount = countPattern(combinedText, /(ì €ëŠ”|ì €í¬|ìš°ë¦¬|ë‚¨í¸|ì œê°€)/g);
            const laughCount = countPattern(combinedText, /(ã…ã…|ã…‹ã…‹|:\)|\^_\^)/g);
            const startPhraseCount = countPattern(combinedText, /(ë°”ë¡œ ì‹œì‘í•´ ë³´ê² ìŠµë‹ˆë‹¤|í›„ê¸° ë°”ë¡œ ì‹œì‘)/g);
            const yoEndingCount = countPattern(combinedText, /ìš”[.!?]?/g);
            const formalEndingCount = countPattern(combinedText, /(ìŠµë‹ˆë‹¤|í–ˆìŠµë‹ˆë‹¤|ë“œë¦½ë‹ˆë‹¤)/g);

            const styleGuide = [];
            if (introRate >= 0.3) styleGuide.push('ë„ì…ì€ ì§§ì€ ì¸ì‚¬ë¡œ ì‹œì‘');
            styleGuide.push('1ì¸ì¹­ ì‹¤ì œ ê²½í—˜ ì¤‘ì‹¬ ì„œìˆ ');
            styleGuide.push('ì •ë³´ ì „ë‹¬ì´ ë¶„ëª…í•œ í›„ê¸° í†¤ ìœ ì§€');
            styleGuide.push('êµ¬ì„±: ë„ì… -> í•µì‹¬ì •ë³´ -> ê²½í—˜ë¦¬ë·° -> ë§ˆë¬´ë¦¬');
            if (startPhraseCount > 0) styleGuide.push('ì—°ê²° ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©');
            if (laughCount > 0) styleGuide.push('ê°€ë²¼ìš´ êµ¬ì–´ì²´(ã…ã…/ã…‹ã…‹)ëŠ” ì†ŒëŸ‰ë§Œ ì‚¬ìš©');
            if (yoEndingCount >= formalEndingCount) styleGuide.push('ì¢…ê²°ì–´ë¯¸ëŠ” í•´ìš”ì²´ ì¤‘ì‹¬');
            else styleGuide.push('ì¢…ê²°ì–´ë¯¸ëŠ” í•©ë‹ˆë‹¤ì²´ ì¤‘ì‹¬');
            if (firstPersonCount === 0) styleGuide.push('ì²´í—˜ ì£¼ì²´ë¥¼ ë¬¸ì¥ì— ëª…ì‹œ');

            const keywords = extractFrequentTokens(samples);
            const snippets = samples.slice(0, 3).map(s => `${s.title}: ${clipText(s.body, 120)}`);

            return {
                blogId,
                analyzedAt: new Date().toISOString(),
                sampleCount: samples.length,
                keywords,
                snippets,
                styleGuide
            };
        }

        async function fetchTextWithCorsFallback(targetUrl) {
            const proxyGetters = [
                (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
                (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
                (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`
            ];

            try {
                const direct = await fetch(targetUrl);
                if (direct.ok) return await direct.text();
            } catch (_) { }

            for (const makeProxyUrl of proxyGetters) {
                try {
                    const proxyUrl = makeProxyUrl(targetUrl);
                    const response = await fetch(proxyUrl);
                    if (!response.ok) continue;

                    const rawData = await response.text();

                    try {
                        const asJson = JSON.parse(rawData);
                        if (asJson.contents) return asJson.contents;
                    } catch (_) { }

                    if (rawData && rawData.includes('<rss')) return rawData;
                } catch (_) { }
            }

            throw new Error('RSS ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨ (CORS ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì œí•œ).');
        }

        async function fetchToneProfileFromRss(blogId) {
            const rssUrl = `https://rss.blog.naver.com/${encodeURIComponent(blogId)}.xml`;
            const xmlText = await fetchTextWithCorsFallback(rssUrl);
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, 'text/xml');
            const parseError = doc.querySelector('parsererror');
            if (parseError) throw new Error('RSS íŒŒì‹± ì‹¤íŒ¨');

            const items = Array.from(doc.querySelectorAll('item')).slice(0, TONE_SAMPLE_COUNT);
            const samples = items.map(item => {
                const title = (item.querySelector('title')?.textContent || '').trim();
                const rawDescription = item.querySelector('description')?.textContent || '';
                return { title, body: cleanRssDescription(rawDescription) };
            }).filter(s => s.title && s.body.length >= 30);

            if (samples.length < 2) throw new Error('ë¶„ì„ìš© ê³µê°œ ê¸€ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return buildToneProfile(blogId, samples);
        }

        function getTonePromptSection(profile) {
            if (!profile) return '';

            const keywordText = profile.keywords.length ? profile.keywords.join(', ') : 'ì—†ìŒ';
            const styleText = profile.styleGuide.map(line => `- ${line}`).join('\n');
            const snippetText = profile.snippets.map((line, idx) => `${idx + 1}. ${line}`).join('\n');

            return `
                [ë¸”ë¡œê·¸ ë§íˆ¬ í”„ë¡œí•„]
                ë¸”ë¡œê·¸ ID: ${profile.blogId}
                ìƒ˜í”Œ ê¸€ ìˆ˜: ${profile.sampleCount}
                í•µì‹¬ í‚¤ì›Œë“œ: ${keywordText}
                ì£¼ì˜: ì•„ë˜ëŠ” ìŠ¤íƒ€ì¼ ì°¸ì¡°ìš©ì´ë©°, ê¸°ì¡´ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ë³µì œí•˜ì§€ ì•ŠëŠ”ë‹¤.
                ìŠ¤íƒ€ì¼ ê·œì¹™:
                ${styleText}
                ë¬¸ì¥ ìƒ˜í”Œ:
                ${snippetText}
            `;
        }

        function getWriterPromptContextSection() {
            const { topic, targetReader, manualKeywords, effectiveKeywords } = getWriterContext();
            const manualKeywordText = manualKeywords.length ? manualKeywords.join(', ') : '(ì‚¬ìš©ì ì§ì ‘ ì…ë ¥ ì—†ìŒ)';
            const effectiveKeywordText = effectiveKeywords.length ? effectiveKeywords.join(', ') : '(ì¶”ì¶œ í‚¤ì›Œë“œ ì—†ìŒ)';
            return `
                [ì‘ì„±ì ì…ë ¥ ì»¨í…ìŠ¤íŠ¸]
                ì£¼ì œ/ë©”ëª¨: ${topic || '(ë¯¸ì…ë ¥)'}
                íƒ€ê¹ƒ ë…ì: ${targetReader}
                ì‚¬ìš©ì ìš°ì„  í‚¤ì›Œë“œ: ${manualKeywordText}
                ì¶”ì²œ í‚¤ì›Œë“œ í›„ë³´: ${effectiveKeywordText}
            `;
        }

        function updateToneStatusFromCache() {
            const blogId = getCurrentBlogId();
            if (!blogId) {
                activeToneProfile = null;
                setToneStatus('ë§íˆ¬ í”„ë¡œí•„: ë¸”ë¡œê·¸ IDë¥¼ ì„¤ì •í•˜ë©´ ìë™ ì ìš©ë©ë‹ˆë‹¤.');
                return;
            }

            const cachedRaw = localStorage.getItem(getToneCacheKey(blogId));
            if (!cachedRaw) {
                activeToneProfile = null;
                setToneStatus('ë§íˆ¬ í”„ë¡œí•„: ì•„ì§ ë¶„ì„í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const cached = JSON.parse(cachedRaw);
                const ageMs = Date.now() - new Date(cached.analyzedAt).getTime();
                if (!cached.analyzedAt || Number.isNaN(ageMs) || ageMs > TONE_CACHE_TTL_MS) {
                    activeToneProfile = null;
                    setToneStatus('ë§íˆ¬ í”„ë¡œí•„: ë§Œë£Œë¨ (ì¬ë¶„ì„ ê¶Œì¥)');
                    return;
                }

                activeToneProfile = cached;
                const dateText = new Date(cached.analyzedAt).toLocaleString();
                setToneStatus(`ë§íˆ¬ í”„ë¡œí•„ ì¤€ë¹„ë¨: ${cached.sampleCount}ê°œ ê¸€ ê¸°ì¤€ (${dateText})`);
            } catch (_) {
                activeToneProfile = null;
                setToneStatus('ë§íˆ¬ í”„ë¡œí•„: ìºì‹œ ì½ê¸° ì‹¤íŒ¨', true);
            }
        }

        async function ensureToneProfile(forceRefresh = false) {
            const blogId = getCurrentBlogId();
            if (!blogId) return null;

            const cacheKey = getToneCacheKey(blogId);
            if (!forceRefresh) {
                const cachedRaw = localStorage.getItem(cacheKey);
                if (cachedRaw) {
                    try {
                        const cached = JSON.parse(cachedRaw);
                        const ageMs = Date.now() - new Date(cached.analyzedAt).getTime();
                        if (cached.analyzedAt && !Number.isNaN(ageMs) && ageMs <= TONE_CACHE_TTL_MS) {
                            activeToneProfile = cached;
                            return cached;
                        }
                    } catch (_) { }
                }
            }

            setToneStatus('ë§íˆ¬ í”„ë¡œí•„ ë¶„ì„ ì¤‘...');
            const profile = await fetchToneProfileFromRss(blogId);
            activeToneProfile = profile;
            localStorage.setItem(cacheKey, JSON.stringify(profile));
            updateToneStatusFromCache();
            return profile;
        }

        async function refreshToneProfile() {
            const inputBlogId = getInputBlogId();
            const blogId = getCurrentBlogId();
            if (inputBlogId && inputBlogId !== blogId) {
                return alert('ë¨¼ì € ID ì €ì¥ì„ ëˆ„ë¥¸ ë’¤ í”„ë¡œí•„ ê°±ì‹ ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
            }
            if (!blogId) return alert('ë¨¼ì € ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            showLoading(true, 'ë¸”ë¡œê·¸ ë§íˆ¬ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...');
            try {
                const profile = await ensureToneProfile(true);
                if (!profile) throw new Error('ë§íˆ¬ í”„ë¡œí•„ ìƒì„± ì‹¤íŒ¨');
                alert(`ë§íˆ¬ ë¶„ì„ ì™„ë£Œ (${profile.sampleCount}ê°œ ê¸€ ê¸°ì¤€)`);
            } catch (e) {
                console.error(e);
                setToneStatus(`ë§íˆ¬ í”„ë¡œí•„ ë¶„ì„ ì‹¤íŒ¨: ${e.message}`, true);
                alert(`ë§íˆ¬ ë¶„ì„ ì‹¤íŒ¨: ${e.message}`);
            } finally {
                showLoading(false);
            }
        }

        function getManagerQuickInputText() {
            return (document.getElementById('managerQuickInput')?.value || '').trim();
        }

        function fillManagerQuickInputFromWriter() {
            const draft = getOutputTextForCount().trim();
            if (!draft) {
                alert('ê¸€ì“°ê¸° ë¹„ì„œ ë³¸ë¬¸ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ì´ˆì•ˆì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.');
                return;
            }

            const el = document.getElementById('managerQuickInput');
            if (!el) return;
            el.value = draft;
            el.focus();
            el.setSelectionRange(0, 0);
        }

        function clearManagerQuickInput() {
            const el = document.getElementById('managerQuickInput');
            if (!el) return;
            el.value = '';
            el.focus();
        }

        function stripInvisibleUnicode(text) {
            return (text || '').replace(/[\u200B-\u200D\u2060\uFEFF\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, '');
        }

        function copyManagerQuickResult() {
            const el = document.getElementById('managerQuickResult');
            if (!el) return;

            const text = (el.innerText || '').trim();
            if (!text || text.includes('ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤')) {
                alert('ë³µì‚¬í•  êµì • ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const safeText = stripInvisibleUnicode(text);
            navigator.clipboard.writeText(safeText)
                .then(() => alert('êµì • ê²°ê³¼ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'))
                .catch(() => alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.'));
        }

        async function runManagerSpellingCheck() {
            if (!checkKey()) return;

            const content = getManagerQuickInputText();
            if (content.length < 10) {
                alert('ë§ì¶¤ë²• ê²€ì‚¬í•  ë¬¸ì¥ì„ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let toneSection = '';
            try {
                const toneProfile = await ensureToneProfile(false);
                toneSection = getTonePromptSection(toneProfile);
            } catch (e) {
                console.warn('Tone profile load failed:', e);
            }

            const prompt = `
                ì—­í• : í•œêµ­ì–´ ë¸”ë¡œê·¸ ë§ì¶¤ë²• ê²€ì‚¬ ë³´ì¡°ì.
                ëª©í‘œ: ì›ë¬¸ì˜ ì˜ë¯¸/í†¤ì„ ìœ ì§€í•˜ë©´ì„œ ì˜¤íƒˆì, ë„ì–´ì“°ê¸°, ì¡°ì‚¬ë§Œ ìµœì†Œ êµì •í•œë‹¤.
                ì¤‘ìš”: ì™„ì„± ëŒ€í•„ ê¸ˆì§€. ìƒˆ ì‚¬ì‹¤ ì¶”ê°€ ê¸ˆì§€. ê³¼ì¥ ë¬¸êµ¬ ì¶”ê°€ ê¸ˆì§€.

                ì¶œë ¥ í˜•ì‹:
                [ë§ì¶¤ë²• ê²€ì‚¬ë³¸]
                (êµì •ëœ ë¬¸ì¥ ì „ì²´)

                [ìˆ˜ì • í¬ì¸íŠ¸]
                - í•µì‹¬ ìˆ˜ì • 3~8ê°œ (ì™œ ìˆ˜ì •í–ˆëŠ”ì§€ í•œ ì¤„ ì„¤ëª…)

                [ì‘ì„±ì í™•ì¸ ì§ˆë¬¸]
                - ì˜ë¯¸ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆëŠ” ì§€ì ì´ ìˆìœ¼ë©´ 1~2ê°œ ì§ˆë¬¸

                ${toneSection}
                [ì›ë¬¸]
                ${content}
            `;

            await callGemini(prompt, [], 'managerQuickResult', 'ë§ì¶¤ë²• ê²€ì‚¬ ì¤‘...');
        }

        async function runManagerSentencePolish() {
            if (!checkKey()) return;

            const content = getManagerQuickInputText();
            if (content.length < 10) {
                alert('ë‹¤ë“¬ì„ ë¬¸ì¥ì„ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            let toneSection = '';
            try {
                const toneProfile = await ensureToneProfile(false);
                toneSection = getTonePromptSection(toneProfile);
            } catch (e) {
                console.warn('Tone profile load failed:', e);
            }

            const prompt = `
                ì—­í• : ë¸”ë¡œê·¸ ë¬¸ì¥ ë‹¤ë“¬ê¸° ë³´ì¡°ì.
                ëª©í‘œ: ì›ë¬¸ ì‚¬ì‹¤ì€ ìœ ì§€í•˜ê³ , ë¬¸ì¥ íë¦„/ê°€ë…ì„±ë§Œ ê°œì„ í•œë‹¤.
                ì¤‘ìš”: ì™„ì„± ëŒ€í•„ ê¸ˆì§€. ìƒˆ ì •ë³´ ì¶”ê°€ ê¸ˆì§€. ê³¼ì¥/ê´‘ê³  ì–´íˆ¬ ê°•í™” ê¸ˆì§€.

                ì¶œë ¥ í˜•ì‹:
                [ë¬¸ì¥ ë‹¤ë“¬ê¸°ë³¸]
                (ë‹¤ë“¬ì€ ë¬¸ì¥ ì „ì²´)

                [ê°œì„  ê·¼ê±°]
                - ê°€ë…ì„±/ì—°ê²°/ì¤‘ë³µ ê´€ì ì—ì„œ 3~6ê°œ

                [ì„ íƒ ìˆ˜ì •ì•ˆ]
                - í‘œí˜„ì´ ê°ˆë¦´ ìˆ˜ ìˆëŠ” ë¬¸ì¥ 2ê°œë§Œ ëŒ€ì•ˆ ì œì‹œ

                ${toneSection}
                [ì›ë¬¸]
                ${content}
            `;

            await callGemini(prompt, [], 'managerQuickResult', 'ë¬¸ì¥ ë‹¤ë“¬ê¸° ì¤‘...');
        }

        function fillAuditInputFromWriterDraft() {
            const draft = getOutputTextForCount().trim();
            if (!draft) {
                alert('ê¸€ì“°ê¸° ë¹„ì„œ ë³¸ë¬¸ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ì´ˆì•ˆì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.');
                return;
            }

            const el = document.getElementById('auditInput');
            if (!el) return;
            el.value = draft;
            el.focus();
            el.setSelectionRange(0, 0);
        }

        // --- AI Logic (Writer) ---
        async function generatePost() {
            if (!checkKey()) return;
            const writerContext = getWriterContext();
            if (!writerContext.topic && userImages.length === 0) return alert('ì£¼ì œë‚˜ ì‚¬ì§„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');

            let toneSection = '';
            try {
                const toneProfile = await ensureToneProfile(false);
                toneSection = getTonePromptSection(toneProfile);
            } catch (e) {
                console.warn('Tone profile load failed:', e);
                setToneStatus(`ë§íˆ¬ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´ ê¸°ë³¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤: ${e.message}`, true);
            }

            const prompt = `
                ì—­í• : ë¸”ë¡œê·¸ ê³µë™ì‘ì„±(co-writing) ë³´ì¡°ì.
                ëª©í‘œ: ì‚¬ìš©ìê°€ ìµœì¢… ì‘ì„±ì„ ì´ì–´ë°›ê¸° ì‰½ê²Œ êµ¬ì¡°ì™€ í•µì‹¬ ì¬ë£Œë¥¼ ì œê³µ.
                ì¶œë ¥ ì–¸ì–´: í•œêµ­ì–´.
                ì¤‘ìš”: ìµœì¢… ë¬¸ì¥ ì™„ì„±ì€ ì‚¬ìš©ìê°€ í•œë‹¤. ë„ˆëŠ” ëŒ€í•„ì´ ì•„ë‹Œ ë³´ì¡°ìë‹¤.

                í•µì‹¬ ì›ì¹™:
                1) ì™„ì„±ë³¸ì„ ê¸¸ê²Œ ëŒ€ì‹  ì¨ì£¼ì§€ ì•ŠëŠ”ë‹¤.
                2) í™•ì¸ë˜ì§€ ì•Šì€ ì‚¬ì‹¤ì€ ê¾¸ë©°ë‚´ì§€ ì•ŠëŠ”ë‹¤.
                3) ì‘ì„±ìê°€ ì±„ì›Œ ë„£ì„ ì—¬ë°±(ë©”ëª¨/ì§ˆë¬¸)ì„ ë‚¨ê¸´ë‹¤.
                4) ì‘ì„±ì í†¤ì€ ëª¨ì‚¬í•˜ë˜ ë¬¸ì¥ ë³µë¶™/ë³µì œëŠ” ê¸ˆì§€í•œë‹¤.

                ì¶œë ¥ í˜•ì‹:
                [0] ì‘ì„± ì „ í•œì¤„ ì „ëµ
                - ì´ë²ˆ ê¸€ì˜ ë…ì/í•µì‹¬ê°€ì¹˜/ì°¨ë³„ì  ìš”ì•½ 1ì¤„

                [1] í¬ìŠ¤íŠ¸ ë°©í–¥ 3ì•ˆ
                - ê° ì•ˆ: ë…ì í¬ì¸íŠ¸ / ì¤‘ì‹¬ ë©”ì‹œì§€ / ì œëª© 1ê°œ

                [2] ì‚¬ì§„ í™œìš© ê°€ì´ë“œ
                - ì‚¬ì§„ì´ ìˆìœ¼ë©´ ë²ˆí˜¸ë³„ ë°°ì¹˜ ì œì•ˆ, ìº¡ì…˜ ì˜ˆì‹œ 1ì¤„, ë„£ì„ í•µì‹¬ í¬ì¸íŠ¸ 1ì¤„
                - ì‚¬ì§„ì´ ì—†ìœ¼ë©´ "ì‚¬ì§„ ì—†ì´ ì‘ì„± ì‹œ ëŒ€ì²´ êµ¬ì„±" ì œì‹œ

                [3] ë³¸ë¬¸ ë¼ˆëŒ€ (ì‚¬ìš©ì ì‘ì„±ìš©)
                - ë„ì… / ì¤‘ê°„ 3~5ë¬¸ë‹¨ / ë§ˆë¬´ë¦¬
                - ê° ë¬¸ë‹¨ì€ 2~3ë¬¸ì¥ ë©”ëª¨ í˜•íƒœ
                - ë¬¸ë‹¨ë§ˆë‹¤ ì‚¬ìš©ìê°€ ì±„ìš¸ ì§ˆë¬¸ 1ê°œ

                [4] ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì§§ì€ ë¬¸ì¥ ì„¸íŠ¸
                - ë„ì… 2ê°œ / ì „í™˜ë¬¸ 4ê°œ / ë§ˆë¬´ë¦¬ 2ê°œ
                - ê³¼ì¥/ê´‘ê³  í†¤ ê¸ˆì§€

                [5] ì‘ì„±ì ë°”í†µ ì²´í¬ë¦¬ìŠ¤íŠ¸ 6ê°œ

                SEO ê°€ì´ë“œ:
                - í‚¤ì›Œë“œëŠ” ë¬¸ë§¥ì— ë§ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ë¶„ì‚° ë°°ì¹˜
                - ì˜ë¯¸ ì—†ëŠ” ë°˜ë³µ/ë‚˜ì—´ì€ ê¸ˆì§€
                - "ë‚´ëˆë‚´ì‚°"ì€ ìƒí™©ì— ë§ì„ ë•Œë§Œ
                - ê³¼ì¥ í‘œí˜„(ìµœê³ , ë¬´ì¡°ê±´, 1ë“±)ì€ ì§€ì–‘

                ${toneSection}
                ${getWriterPromptContextSection()}
                ì‚¬ì§„ ê°œìˆ˜: ${userImages.length}
            `;

            const ok = await callGemini(
                prompt,
                userImages,
                'outputContent',
                'ê³µë™ì‘ì„±ìš© ì´ˆì•ˆì„ ì¤€ë¹„í•˜ëŠ” ì¤‘...'
            );
            if (ok) {
                updateSeoScoreBadge(null);
                setAssistStatus('ì´ˆì•ˆ ìƒì„± ì™„ë£Œ');
            }
        }

        // --- AI Logic (Spell Check) ---
        async function fixSpelling() {
            if (!checkKey()) return;
            const content = document.getElementById('outputContent').innerText;
            if (!content || content.length < 10) return alert('ìˆ˜ì •í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');

            let toneSection = '';
            try {
                const toneProfile = await ensureToneProfile(false);
                toneSection = getTonePromptSection(toneProfile);
            } catch (e) {
                console.warn('Tone profile load failed:', e);
                setToneStatus(`ë§íˆ¬ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´ ê¸°ë³¸ êµì •ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤: ${e.message}`, true);
            }

            const prompt = `
                ì—­í• : í•œêµ­ì–´ ë¸”ë¡œê·¸ ë¬¸ì¥ êµì • ë³´ì¡°ì.
                ëª©í‘œ: ê¸€ì“´ì´ì˜ ì›ë˜ ë§íˆ¬ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìµœì†Œ êµì •ë§Œ ìˆ˜í–‰.

                ê·œì¹™:
                1) ë§ì¶¤ë²•, ë„ì–´ì“°ê¸°, ì–´ìƒ‰í•œ í‘œí˜„ë§Œ ìˆ˜ì •í•œë‹¤.
                2) ë¬¸ë‹¨ êµ¬ì¡°ì™€ íë¦„ì€ ìµœëŒ€í•œ ìœ ì§€í•œë‹¤.
                3) ìƒˆ ì£¼ì¥ì´ë‚˜ ê³¼ì¥ ë¬¸ì¥ì„ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.

                ìŠ¤íƒ€ì¼ ì •í•©ì„±:
                - ì•„ë˜ ë§íˆ¬ í”„ë¡œí•„ì„ ìš°ì„  ë°˜ì˜í•´ êµì •í•œë‹¤.
                - í‘œí˜„ì„ ë°”ê¿€ ë•Œë„ ì‘ì„±ì ê³ ìœ  ì–´ì¡°ë¥¼ ìœ ì§€í•œë‹¤.
                ${toneSection}
                ${getWriterPromptContextSection()}

                ì¶œë ¥ í˜•ì‹:
                [êµì •ë³¸]
                (ì „ì²´ ë¬¸ì¥)

                [ì„ íƒ ìˆ˜ì • í¬ì¸íŠ¸]
                - ìµœëŒ€ 5ê°œ

                [ì›ë¬¸]
                ${content}
            `;

            const ok = await callGemini(prompt, [], 'outputContent', 'ìµœì†Œ êµì • ì¤‘...');
            if (ok) updateSeoScoreBadge(null);
        }

        async function generatePublishPack() {
            if (!checkKey()) return;

            const draftText = getOutputTextForCount().trim();
            const writerContext = getWriterContext();

            if (!writerContext.topic && draftText.length < 80) {
                return alert('ì£¼ì œ ë˜ëŠ” ì´ˆì•ˆ ë³¸ë¬¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë¨¼ì € ì´ˆì•ˆì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.');
            }

            // Enhanced UX: Auto-open panel on mobile if closed
            if (window.innerWidth < 1024) {
                setPublishPanelMobileOpen(true);
            }

            let toneSection = '';
            try {
                const toneProfile = await ensureToneProfile(false);
                toneSection = getTonePromptSection(toneProfile);
            } catch (e) {
                console.warn('Tone profile load failed:', e);
            }

            setAssistStatus('AI ë°œí–‰ ìš”ì†Œ ìƒì„± ì¤‘...');

            const prompt = `
                ì—­í• : ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë°œí–‰ ì§ì „ í¸ì§‘ ë³´ì¡°ì.
                ëª©í‘œ: ì‘ì„±ìê°€ ìµœì¢… í¸ì§‘ì„ ë¹ ë¥´ê²Œ ëë‚¼ ìˆ˜ ìˆê²Œ ì œëª©/ì¸ë„¤ì¼/í‚¤ì›Œë“œ/íƒœê·¸/ë…¸ì¶œ ê°œì„ ì•ˆì„ ì œì‹œ.
                ì „ì œ: ë³¸ë¬¸ ëŒ€í•„ ê¸ˆì§€. ì œì•ˆ ì¤‘ì‹¬ìœ¼ë¡œë§Œ ì‘ì„±.

                ì‘ì„± ì›ì¹™:
                1) í—ˆìœ„/ê³¼ì¥/ê²€ì¦ë¶ˆê°€ ì •ë³´ ê¸ˆì§€
                2) ë³¸ë¬¸ ì£¼ì œì™€ ë§ëŠ” ì œì•ˆë§Œ ì¶œë ¥
                3) ìƒì—…ì„± ê³¼ì¥ í‘œí˜„ì€ ìµœì†Œí™”
                4) ì‚¬ìš©ìì—ê²Œ ì‹¤ì œ ë„ì›€ë˜ëŠ” ì •ë³´(ê°€ê²©/ì‹œê°„/ìœ„ì¹˜/ê²½í—˜ ê·¼ê±°) ìš°ì„ 

                ì¶œë ¥ í˜•ì‹:
                [ì œëª© í›„ë³´]
                - ê²€ìƒ‰í˜• 5ê°œ
                - ê³µê°í˜• 5ê°œ
                - ì§§ì€í˜• 3ê°œ (20ì ë‚´ì™¸)

                [ì¸ë„¤ì¼ ì œì•ˆ 3ì•ˆ]
                - ì¶”ì²œ ì‚¬ì§„ ë²ˆí˜¸(ì—†ìœ¼ë©´ ì´ë¯¸ì§€ ì½˜ì…‰íŠ¸)
                - ì¸ë„¤ì¼ ë¬¸êµ¬ (10~16ì)
                - ìƒ‰ê°/ë°°ì¹˜ íŒ 1ì¤„

                [í‚¤ì›Œë“œ ë§µ]
                - ë©”ì¸ í‚¤ì›Œë“œ 1~2ê°œ
                - ì„œë¸Œ í‚¤ì›Œë“œ 6ê°œ
                - ì—°ê´€ í‚¤ì›Œë“œ 10ê°œ

                [í•´ì‹œíƒœê·¸]
                - ë„¤ì´ë²„ ë¸”ë¡œê·¸ìš© 15ê°œ
                - ë„ˆë¬´ ì¼ë°˜ì ì¸ íƒœê·¸ëŠ” ì œì™¸
                - ë³¸ë¬¸ ì£¼ì œì™€ ë¬´ê´€í•œ íƒœê·¸ëŠ” ì œì™¸

                [ë…¸ì¶œ ê°œì„  ì²´í¬ë¦¬ìŠ¤íŠ¸]
                - ì§€ê¸ˆ ê¸€ì—ì„œ ë³´ì™„í•  7ê°€ì§€
                - ìš°ì„ ìˆœìœ„ High/Mediumìœ¼ë¡œ êµ¬ë¶„

                ${toneSection}
                ${getWriterPromptContextSection()}
                ì‚¬ì§„ ê°œìˆ˜: ${userImages.length}
                í˜„ì¬ ì´ˆì•ˆ:
                ${draftText || '(ì´ˆì•ˆ ì—†ìŒ)'}
            `;

            const ok = await callGemini(
                prompt,
                [],
                'assistContent',
                'ë°œí–‰ ìš”ì†Œ ìƒì„± ì¤‘...'
            );
            if (ok) {
                setAssistStatus('AI ë°œí–‰ ìš”ì†Œ ìƒì„± ì™„ë£Œ');
            } else {
                setAssistStatus('AI ë°œí–‰ ìš”ì†Œ ìƒì„± ì‹¤íŒ¨', true);
            }
        }

        // --- AI Logic (Audit) ---
        async function fetchAndAuditPost() {
            const url = document.getElementById('auditUrlInput').value.trim();
            if (!url) return alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');

            showLoading(true, "ë¸”ë¡œê·¸ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 5ì´ˆ ì†Œìš”)");

            try {
                // 1. Parsing LogNo and BlogId
                let blogId = '';
                let logNo = '';

                if (url.includes('blog.naver.com')) {
                    const parts = url.split('/');
                    const lastPart = parts.pop();
                    const secondLast = parts.pop();

                    if (!isNaN(lastPart)) {
                        logNo = lastPart;
                        blogId = secondLast;
                    }
                }

                if (!logNo || !blogId) {
                    const urlObj = new URL(url);
                    blogId = urlObj.searchParams.get('blogId') || blogId;
                    logNo = urlObj.searchParams.get('logNo') || logNo;
                }

                if (!logNo || !blogId) {
                    throw new Error("ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì£¼ì†Œë¥¼ ì •í™•íˆ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\\n(ì˜ˆ: https://blog.naver.com/ì•„ì´ë””/ê²Œì‹œê¸€ë²ˆí˜¸)");
                }

                // 2. Fetch via CORS Proxy (Fallback Strategy)
                const targetUrl = `https://m.blog.naver.com/${blogId}/${logNo}`;

                // List of proxies to try
                const proxies = [
                    (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
                    (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
                    (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`
                ];

                let data = null;
                let success = false;

                for (const proxyGen of proxies) {
                    try {
                        const proxyUrl = proxyGen(targetUrl);
                        const response = await fetch(proxyUrl);
                        if (!response.ok) throw new Error('Network response was not ok');

                        // Handle different proxy response formats
                        const rawData = await response.text();

                        // AllOrigins returns JSON
                        try {
                            const json = JSON.parse(rawData);
                            if (json.contents) {
                                data = json.contents;
                                success = true;
                                break;
                            }
                        } catch (e) {
                            // Valid HTML returned directly (CodeTabs, CorsProxy)
                            if (rawData.includes('<html') || rawData.includes('<div')) {
                                data = rawData;
                                success = true;
                                break;
                            }
                        }
                    } catch (e) {
                        console.warn('Proxy failed:', e);
                        continue;
                    }
                }

                if (!success || !data) throw new Error("ëª¨ë“  ìš°íšŒ ê²½ë¡œë¡œ ì ‘ì†ì„ ì‹œë„í–ˆìœ¼ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸”ë¡œê·¸ê°€ ë¹„ê³µê°œì´ê±°ë‚˜ ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");

                // 3. Parse HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');

                // 4. Extract Text
                let contentText = "";
                const mainContainer = doc.querySelector('.se-main-container') || doc.querySelector('.post_ct') || doc.body;

                // Remove scripts and styles
                const scripts = mainContainer.querySelectorAll('script, style');
                scripts.forEach(s => s.remove());

                contentText = mainContainer.innerText || mainContainer.textContent;
                contentText = contentText.replace(/\n\s*\n/g, '\n').trim();

                if (contentText.length < 50) throw new Error("ë³¸ë¬¸ ë‚´ìš©ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì´ë¯¸ì§€ ìœ„ì£¼ì˜ ê¸€ì´ê±°ë‚˜ êµ¬ì¡°ê°€ ë‹¤ë¦„)");

                document.getElementById('auditInput').value = contentText;
                alert("ì„±ê³µì ìœ¼ë¡œ ë‚´ìš©ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤! ğŸš€\nì´ì œ 'AI ì •ë°€ì§„ë‹¨ ì‹¤í–‰' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.");

            } catch (e) {
                console.error(e);
                alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ ã… ã… \n" + e.message + "\n\n(ìˆ˜ë™ìœ¼ë¡œ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”)");
            } finally {
                showLoading(false);
            }
        }

        async function auditPost() {
            if (!checkKey()) return;
            const content = (document.getElementById('auditInput')?.value || '').trim();
            if (content.length < 80) {
                alert('ì •ë°€ì§„ë‹¨í•  ë³¸ë¬¸ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. 80ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const writerContext = getWriterContext();
            let toneSection = '';
            try {
                const toneProfile = await ensureToneProfile(false);
                toneSection = getTonePromptSection(toneProfile);
            } catch (e) {
                console.warn('Tone profile load failed:', e);
            }

            const prompt = `
                ì—­í• : ë„¤ì´ë²„ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì½”ì¹˜(ë³´ì¡°í˜•).
                ëª©í‘œ: ì‘ì„±ìê°€ ìµœì¢… ìˆ˜ì •í•  ë•Œ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ í”¼ë“œë°±ì„ ì œê³µí•œë‹¤.
                ì¤‘ìš” ì›ì¹™:
                1) ì™„ì„± ëŒ€í•„ ê¸ˆì§€, ë³´ì¡° ì¤‘ì‹¬.
                2) ìƒˆ ì‚¬ì‹¤/ìˆ˜ì¹˜ ì¶”ê°€ ê¸ˆì§€.
                3) ê³¼ì¥/ê´‘ê³  í†¤ ê°•í™” ê¸ˆì§€.
                4) ì‹¤í–‰ ê°€ëŠ¥í•œ ìˆ˜ì • ì•¡ì…˜ì„ ìš°ì„  ì œì‹œ.

                ì¶œë ¥ í˜•ì‹:
                [ì§„ë‹¨ ìš”ì•½]
                - ê°•ì  2~3ê°œ
                - ìš°ì„  ë³´ì™„ 2~3ê°œ

                [ì ìˆ˜í‘œ 100ì ]
                - ë…ì ì í•©ì„±
                - ë„ì…/ì „ê°œ íë¦„
                - ì •ë³´ ë°€ë„/ê·¼ê±°
                - ê°€ë…ì„±(ë¬¸ë‹¨, ë¬¸ì¥ ê¸¸ì´)
                - SEO ìì—°ìŠ¤ëŸ¬ì›€
                - ì‹ ë¢°ì„±(ê³¼ì¥/ë¬´ê´€ í‘œí˜„)
                - ì´ì 

                [ë¦¬ìŠ¤í¬ ê°ì§€]
                - í‚¤ì›Œë“œ ê³¼ë‹¤ ë°˜ë³µ, ê³¼ì¥ í‘œí˜„, ë¬¸ë‹¨ ê³¼ë°€, ë¬´ê´€ í•´ì‹œíƒœê·¸/ì£¼ì œ ì´íƒˆ ì—¬ë¶€

                [ìˆ˜ì • ì•¡ì…˜ Top 5]
                - ìš°ì„ ìˆœìœ„(H/M)
                - ìˆ˜ì • ìœ„ì¹˜(ë„ì…/ì¤‘ê°„/ë§ˆë¬´ë¦¬)
                - ì™œ ìˆ˜ì •í•˜ëŠ”ì§€ 1ë¬¸ì¥
                - ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ì˜ˆì‹œ ë¬¸ì¥ 1ê°œ(90ì ì´ë‚´)

                [ë°œí–‰ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸ 7ê°œ]
                - ì‘ì„±ìê°€ ìµœì¢… í™•ì¸í•  í•­ëª©ë§Œ ê°„ê²°íˆ

                ${toneSection}
                ${getWriterPromptContextSection()}

                [ì§„ë‹¨ ëŒ€ìƒ ë³¸ë¬¸]
                ${content}
            `;

            await callGemini(prompt, [], 'auditResult', 'í¬ìŠ¤íŒ… ì •ë°€ì§„ë‹¨ ì¤‘...');
        }

        // --- Common API Call ---
        let cachedModelId = null;

        function sanitizeApiKey(raw) {
            return (raw || '').trim();
        }

        function createApiKeyEntry(name, key) {
            return {
                id: `k_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,
                name: (name || '').trim(),
                key: sanitizeApiKey(key),
                createdAt: new Date().toISOString()
            };
        }

        function readApiKeyList() {
            const raw = localStorage.getItem(API_KEY_LIST_STORAGE_KEY);
            if (!raw) return [];
            try {
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) return [];

                return parsed
                    .map(item => ({
                        id: String(item?.id || ''),
                        name: String(item?.name || ''),
                        key: sanitizeApiKey(item?.key || ''),
                        createdAt: String(item?.createdAt || '')
                    }))
                    .filter(item => item.id && item.key);
            } catch (_) {
                return [];
            }
        }

        function writeApiKeyList(list) {
            localStorage.setItem(API_KEY_LIST_STORAGE_KEY, JSON.stringify(list));
        }

        function getActiveApiKeyId() {
            return localStorage.getItem(API_KEY_ACTIVE_ID_STORAGE_KEY) || '';
        }

        function setActiveApiKeyId(id) {
            if (id) localStorage.setItem(API_KEY_ACTIVE_ID_STORAGE_KEY, id);
            else localStorage.removeItem(API_KEY_ACTIVE_ID_STORAGE_KEY);
        }

        function ensureActiveApiKeyExists() {
            const list = readApiKeyList();
            if (!list.length) {
                setActiveApiKeyId('');
                return null;
            }

            const activeId = getActiveApiKeyId();
            const active = list.find(item => item.id === activeId) || list[0];
            if (!activeId || active.id !== activeId) {
                setActiveApiKeyId(active.id);
            }
            return active;
        }

        function getActiveApiKeyEntry() {
            const active = ensureActiveApiKeyExists();
            if (!active) return null;
            return readApiKeyList().find(item => item.id === active.id) || null;
        }

        function maskApiKey(key) {
            const cleaned = sanitizeApiKey(key);
            if (!cleaned) return '';
            if (cleaned.length <= 10) return `${cleaned.slice(0, 2)}***`;
            return `${cleaned.slice(0, 6)}...${cleaned.slice(-4)}`;
        }

        function migrateLegacyApiKeyStorage() {
            const legacyKey = sanitizeApiKey(localStorage.getItem('gemini_api_key'));
            if (!legacyKey) return;

            const list = readApiKeyList();
            const exists = list.some(item => item.key === legacyKey);
            if (!exists) {
                list.unshift(createApiKeyEntry('ê¸°ì¡´ ì €ì¥ í‚¤', legacyKey));
                writeApiKeyList(list);
            }

            if (!getActiveApiKeyId()) {
                const first = readApiKeyList()[0];
                if (first) setActiveApiKeyId(first.id);
            }

            localStorage.removeItem('gemini_api_key');
        }

        function renderApiKeyManager() {
            const selectEl = document.getElementById('apiKeySelect');
            const statusEl = document.getElementById('apiKeyStatusText');
            const inputEl = document.getElementById('apiKeyInput');
            const aliasEl = document.getElementById('apiKeyAliasInput');
            const useBtn = document.getElementById('useSelectedBtn');
            const removeBtn = document.getElementById('disconnectBtn');
            if (!selectEl || !statusEl) return;

            const list = readApiKeyList();
            const active = ensureActiveApiKeyExists();
            const activeId = active?.id || '';

            selectEl.innerHTML = '';
            if (!list.length) {
                const emptyOpt = document.createElement('option');
                emptyOpt.value = '';
                emptyOpt.textContent = 'ì €ì¥ëœ API í‚¤ ì—†ìŒ';
                selectEl.appendChild(emptyOpt);
                selectEl.disabled = true;
                if (useBtn) useBtn.disabled = true;
                if (removeBtn) removeBtn.disabled = true;
                statusEl.textContent = 'í™œì„± API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ í‚¤ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.';
                statusEl.className = 'text-xs text-gray-500 mt-2';
            } else {
                for (const item of list) {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    const label = item.name ? item.name : 'ì´ë¦„ ì—†ìŒ';
                    opt.textContent = `${label} Â· ${maskApiKey(item.key)}`;
                    selectEl.appendChild(opt);
                }

                selectEl.disabled = false;
                selectEl.value = activeId || list[0].id;
                if (useBtn) useBtn.disabled = false;
                if (removeBtn) removeBtn.disabled = false;

                const activeLabel = active?.name || 'ì´ë¦„ ì—†ìŒ';
                statusEl.textContent = `í™œì„± í‚¤: ${activeLabel} (${maskApiKey(active?.key || '')})`;
                statusEl.className = 'text-xs text-gray-500 mt-2';
            }

            if (inputEl) inputEl.value = '';
            if (aliasEl) aliasEl.value = '';
        }

        function getStoredApiKey() {
            return sanitizeApiKey(getActiveApiKeyEntry()?.key || '');
        }

        function getErrorMessageFromResponse(response, data) {
            if (data && data.error && data.error.message) return data.error.message;
            return `HTTP ${response.status} ${response.statusText}`;
        }

        function isGenerationCapableModel(model) {
            const methods = Array.isArray(model?.supportedGenerationMethods) ? model.supportedGenerationMethods : [];
            return methods.includes('generateContent') || methods.includes('generateMessage');
        }

        async function getBestModel(apiKey) {
            // Check cache first (session variable)
            if (cachedModelId) return cachedModelId;

            try {
                // Fetch list of available models
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models', {
                    headers: { 'x-goog-api-key': apiKey }
                });
                const data = await response.json().catch(() => ({}));

                if (!response.ok || data.error) throw new Error("API í‚¤ í™•ì¸ ì‹¤íŒ¨: " + getErrorMessageFromResponse(response, data));
                if (!Array.isArray(data.models)) throw new Error("ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

                // 1. Try to find preferred models
                for (const pref of GEMINI_MODEL_PREFERENCES) {
                    const found = data.models.find(m =>
                        m.name?.includes(pref) &&
                        isGenerationCapableModel(m)
                    );
                    if (found) {
                        cachedModelId = found.name.replace('models/', '');
                        console.log(`Found preferred model: ${cachedModelId}`);
                        return cachedModelId;
                    }
                }

                // 2. Fallback: Find ANY model that supports text generation
                const fallback = data.models.find(m => isGenerationCapableModel(m));
                if (fallback) {
                    cachedModelId = fallback.name.replace('models/', '');
                    return cachedModelId;
                }

                throw new Error("ê¸€ì“°ê¸°ê°€ ê°€ëŠ¥í•œ AI ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            } catch (e) {
                console.warn("Model discovery failed:", e);
                // Fallback default if list fails
                return DEFAULT_GEMINI_MODEL;
            }
        }

        async function requestGeminiText(prompt, images, loadingMessage = "ìµœì ì˜ AI ëª¨ë¸ì„ ì—°ê²°í•˜ê³  ìˆìŠµë‹ˆë‹¤...") {
            const apiKey = getStoredApiKey();
            if (!apiKey) throw new Error("API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.");

            let modelName = DEFAULT_GEMINI_MODEL;

            showLoading(true, loadingMessage);

            try {
                // Dynamically find the best model for this key
                modelName = await getBestModel(apiKey);
            } catch (e) {
                console.warn("Using default model due to discovery error");
            }

            try {
                const requestBody = { contents: [{ parts: [{ text: prompt }, ...images] }] };
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json().catch(() => ({}));

                if (!response.ok || data.error) {
                    throw new Error(`[${modelName}] ì˜¤ë¥˜: ${getErrorMessageFromResponse(response, data)}`);
                }

                const parts = data?.candidates?.[0]?.content?.parts || [];
                const text = parts.map(p => p.text || '').join('\n').trim();
                if (!text) throw new Error(`[${modelName}] ì‘ë‹µ í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.`);
                return text;
            } catch (e) {
                throw e;
            } finally {
                showLoading(false);
            }
        }

        async function callGemini(prompt, images, outputId, loadingMessage = "ìµœì ì˜ AI ëª¨ë¸ì„ ì—°ê²°í•˜ê³  ìˆìŠµë‹ˆë‹¤...") {
            try {
                const text = await requestGeminiText(prompt, images, loadingMessage);
                const outputEl = document.getElementById(outputId);
                if (!outputEl) throw new Error(`ì¶œë ¥ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${outputId}`);
                outputEl.innerHTML = marked.parse(text);
                if (outputId === 'outputContent') updateCharCount();
                return true;
            } catch (e) {
                alert('AI í˜¸ì¶œ ì‹¤íŒ¨:\n' + e.message + '\n\nAPI í‚¤ ê¶Œí•œì´ë‚˜ ì‚¬ìš©ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return false;
            }
        }

        // --- Blog Management ---
        function saveBlogId() {
            const inputEl = document.getElementById('blogIdInput');
            if (!inputEl) return;

            const inputVal = normalizeBlogId(inputEl.value);

            if (inputVal) {
                localStorage.setItem('naver_blog_id', inputVal);
                inputEl.value = inputVal;
                activeToneProfile = null;
                updateToneStatusFromCache();
                alert(`ì•„ì´ë”” '${inputVal}' ì €ì¥ ì™„ë£Œ! ğŸ“¡`);
            } else {
                alert('ì˜¬ë°”ë¥¸ ë„¤ì´ë²„ ì•„ì´ë””ë‚˜ ë¸”ë¡œê·¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }
        function loadBlogId() {
            const id = normalizeBlogId(localStorage.getItem('naver_blog_id'));
            const inputEl = document.getElementById('blogIdInput');
            if (!inputEl) return;
            inputEl.value = id || '';
        }
        function resetToneProfile() {
            const inputBlogId = getInputBlogId();
            const blogId = getCurrentBlogId();
            if (inputBlogId && inputBlogId !== blogId) {
                return alert('ë¨¼ì € ID ì €ì¥ì„ ëˆ„ë¥¸ ë’¤ ì´ˆê¸° ë¦¬ì…‹ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
            }
            if (!blogId) {
                setToneStatus('ë§íˆ¬ í”„ë¡œí•„: ë¸”ë¡œê·¸ IDë¥¼ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.', true);
                return alert('ë¨¼ì € ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì•„ì´ë””ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.');
            }

            if (!confirm(`'${blogId}' ë§íˆ¬ í”„ë¡œí•„ ìºì‹œë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?`)) return;

            localStorage.removeItem(getToneCacheKey(blogId));
            activeToneProfile = null;
            setToneStatus('ë§íˆ¬ í”„ë¡œí•„: ì´ˆê¸°í™”ë¨ (í”„ë¡œí•„ ê°±ì‹  ë²„íŠ¼ìœ¼ë¡œ ì¬ë¶„ì„ ê°€ëŠ¥)');
            alert('ë§íˆ¬ í”„ë¡œí•„ ìºì‹œë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
        }
        function openAnalysis(type) {
            const id = getCurrentBlogId();
            if (!id) return alert('ë¨¼ì € ë„¤ì´ë²„ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”!');

            let url = '';
            if (type === 'blackkiwi') url = `https://blackkiwi.net/`; // BlackKiwi doesn't support direct linking via GET param easily, directing to home
            if (type === 'blogchart') url = `https://www.blogchart.co.kr/`;
            if (type === 'naverstats') url = `https://blog.stat.naver.com/blog/${id}`;

            window.open(url, '_blank');
        }

        // --- Helpers ---
        function checkApiKey() {
            migrateLegacyApiKeyStorage();
            ensureActiveApiKeyExists();
        }
        function checkKey() {
            const key = getStoredApiKey();
            if (!key) {
                alert('ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
                const modal = document.getElementById('settingsModal');
                if (modal?.classList.contains('hidden')) toggleSettings();
                return false;
            }
            return true;
        }
        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            if (!m) return;

            const willOpen = m.classList.contains('hidden');
            m.classList.toggle('hidden');
            if (willOpen) {
                loadBlogId();
                updateToneStatusFromCache();
                renderApiKeyManager();
            }
        }
        function saveApiKey() {
            const key = sanitizeApiKey(document.getElementById('apiKeyInput')?.value);
            const alias = (document.getElementById('apiKeyAliasInput')?.value || '').trim();
            if (!key) return alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            if (key.startsWith('sk-')) {
                return alert('ì´ í˜ì´ì§€ëŠ” í˜„ì¬ Gemini API í‚¤(AIzaSy...) ì „ìš©ì…ë‹ˆë‹¤. GPTë¥¼ ì“°ë ¤ë©´ OpenAI API ì—°ë™ ì½”ë“œë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.');
            }

            const list = readApiKeyList();
            const existing = list.find(item => item.key === key);
            let activeId = '';

            if (existing) {
                existing.name = alias || existing.name || 'ì €ì¥ëœ í‚¤';
                activeId = existing.id;
            } else {
                const newEntry = createApiKeyEntry(alias || `í‚¤ ${list.length + 1}`, key);
                list.unshift(newEntry);
                activeId = newEntry.id;
            }

            writeApiKeyList(list);
            setActiveApiKeyId(activeId);
            cachedModelId = null;
            renderApiKeyManager();
            alert('API í‚¤ ì €ì¥ ì™„ë£Œ. í™œì„± í‚¤ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        function activateSelectedApiKey() {
            const selectEl = document.getElementById('apiKeySelect');
            const selectedId = selectEl?.value || '';
            if (!selectedId) return alert('ì„ íƒí•  API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.');

            const list = readApiKeyList();
            const target = list.find(item => item.id === selectedId);
            if (!target) return alert('ì„ íƒí•œ API í‚¤ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

            setActiveApiKeyId(target.id);
            cachedModelId = null;
            renderApiKeyManager();
            alert(`í™œì„± API í‚¤ë¥¼ '${target.name || 'ì´ë¦„ ì—†ìŒ'}'ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);
        }
        function disconnectApiKey() {
            const selectEl = document.getElementById('apiKeySelect');
            const selectedId = selectEl?.value || '';
            if (!selectedId) return alert('ì‚­ì œí•  API í‚¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            if (!confirm('ì„ íƒí•œ API í‚¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const before = readApiKeyList();
            const next = before.filter(item => item.id !== selectedId);
            if (next.length === before.length) return;

            writeApiKeyList(next);
            if (getActiveApiKeyId() === selectedId) {
                setActiveApiKeyId(next[0]?.id || '');
            }

            cachedModelId = null;
            renderApiKeyManager();
            alert('ì„ íƒí•œ API í‚¤ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
        }
        function showLoading(b, msg) {
            const o = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = msg || "ë¡œë”© ì¤‘...";
            if (b) o.classList.remove('hidden'); else o.classList.add('hidden');
        }
        function copyToClipboard() {
            const raw = document.getElementById('outputContent').innerText;
            const safeText = stripInvisibleUnicode(raw);
            navigator.clipboard.writeText(safeText).then(() => alert('ë³µì‚¬ ì™„ë£Œ!'));
        }
        function downloadAsFile() { /* simplified for brevity */
            const raw = document.getElementById('outputContent').innerText;
            const c = stripInvisibleUnicode(raw);
            const b = new Blob([c], { type: 'text/plain' });
            const u = window.URL.createObjectURL(b);
            const a = document.createElement('a'); a.href = u; a.download = 'blog.txt'; a.click();
        }
        function setPublishPanelMobileOpen(open) {
            const panel = document.getElementById('publishPanelContent');
            const btn = document.getElementById('publishPanelToggleBtn');
            if (!panel || !btn) return;

            if (window.innerWidth >= 1024) {
                panel.classList.remove('is-open');
                panel.style.maxHeight = '';
                panel.style.opacity = '';
                btn.textContent = 'ì—´ê¸°';
                btn.setAttribute('aria-expanded', 'true');
                return;
            }

            const shouldOpen = Boolean(open);
            panel.classList.toggle('is-open', shouldOpen);
            btn.textContent = shouldOpen ? 'ë‹«ê¸°' : 'ì—´ê¸°';
            btn.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
        }

        function togglePublishPanelMobile() {
            if (window.innerWidth >= 1024) return;
            const panel = document.getElementById('publishPanelContent');
            if (!panel) return;
            setPublishPanelMobileOpen(!panel.classList.contains('is-open'));
        }

        // Keep panel state sane when viewport switches between mobile and desktop.
        window.addEventListener('resize', () => {
            setPublishPanelMobileOpen(false);
        });
    </script>
</body>

</html>
